<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Digital Whiteboardï½œHTML5 ç²¾ç¾ç¯„ä¾‹</title>
<style>
:root{
  --bg:#0f172a; /* slate-900 */
  --panel:#0b1220ee;
  --ink:#e5e7eb; /* default pen */
  --muted:#94a3b8;
  --primary:#22d3ee; /* cyan */
  --accent:#a78bfa; /* violet */
  --warn:#fb7185;   /* rose */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:radial-gradient(1200px 800px at 50% -200px,#1e293b,var(--bg));
  color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;
  display:flex;flex-direction:column;overflow:hidden;
}
.header{display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid #1f2937;background:linear-gradient(#0b1220, #0b1220f2);backdrop-filter:blur(8px)}
.logo{font-weight:800;letter-spacing:1px}
.badge{font-size:12px;padding:4px 8px;border:1px solid #334155;border-radius:999px;color:var(--muted)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;box-shadow:0 2px 0 #00000055;user-select:none}
.btn:hover{filter:brightness(1.12)}
.btn.active{outline:2px solid var(--primary);}
.sep{width:1px;height:28px;background:#243041;margin:0 6px}
label{font-size:13px;color:var(--muted)}
input[type="range"]{accent-color:var(--primary)}
.color{width:28px;height:28px;border-radius:8px;border:1px solid #334155;cursor:pointer}
.picker{display:flex;gap:6px;align-items:center}
.right{margin-left:auto;display:flex;gap:8px;align-items:center}

.canvas-wrap{position:relative;flex:1;overflow:hidden}
#grid{position:absolute;inset:0;pointer-events:none;background-size:40px 40px;background-image:linear-gradient(to right,#1f2937 1px,transparent 1px),linear-gradient(to bottom,#1f2937 1px,transparent 1px);opacity:.35}
#board{position:absolute;inset:0;touch-action:none;cursor:crosshair}
.hint{position:absolute;left:12px;bottom:12px;color:var(--muted);background:#0b1220cc;border:1px solid #1f2937;border-radius:10px;padding:8px 10px;backdrop-filter:blur(6px);font-size:13px}
.toast{position:absolute;top:16px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #1f2937;border-radius:12px;padding:10px 14px;opacity:0;transition:opacity .25s ease}
.toast.show{opacity:1}

/* floating text editor */
.text-editor{position:absolute;z-index:10;display:none}
.text-editor textarea{min-width:280px;min-height:80px;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:#e5e7eb;font-size:20px;line-height:1.4}
.text-editor .actions{margin-top:6px;display:flex;gap:6px}

/* sticker note */
.note{position:absolute;min-width:120px;min-height:80px;padding:10px 12px;border-radius:12px;background:#fde68a;color:#1f2937;border:1px solid #f59e0b;box-shadow:0 8px 30px #00000055}
.note .handle{position:absolute;right:6px;top:6px;font-size:12px;color:#78350f;cursor:grab}

footer{display:flex;gap:12px;align-items:center;justify-content:center;color:var(--muted);padding:8px;border-top:1px solid #1f2937;background:#0b1220}
kbd{background:#111827;padding:2px 5px;border-radius:6px;border:1px solid #374151;color:#e5e7eb;font-size:12px}
</style>
</head>
<body>
  <div class="header">
    <div class="logo">Digital Whiteboard</div>
    <span class="badge">HTML5 â€¢ Pointer Events â€¢ é›¢ç·šå¯ç”¨</span>

    <div class="toolbar">
      <button class="btn tool" data-tool="pen" title="ç•«ç­† (P)">âœï¸ ç•«ç­†</button>
      <button class="btn tool" data-tool="highlighter" title="è¢å…‰ç­† (H)">ğŸ–ï¸ è¢å…‰ç­†</button>
      <button class="btn tool" data-tool="eraser" title="æ©¡çš®æ“¦ (E)">ğŸ§½ æ©¡çš®æ“¦</button>
      <div class="sep"></div>
      <button class="btn tool" data-tool="line" title="ç›´ç·š (L)">ğŸ“ ç›´ç·š</button>
      <button class="btn tool" data-tool="rect" title="çŸ©å½¢ (R)">â–­ çŸ©å½¢</button>
      <button class="btn tool" data-tool="text" title="æ–‡å­— (T)">ğŸ”¤ æ–‡å­—</button>
      <button class="btn tool" data-tool="laser" title="é›·å°„ç­† (Z)">ğŸ”´ é›·å°„</button>
      <div class="sep"></div>
      <div class="picker">
        <label>é¡è‰²</label>
        <input type="color" id="color" value="#e5e7eb" class="color" />
      </div>
      <div class="picker">
        <label>ç²—ç´°</label>
        <input type="range" id="size" min="1" max="60" value="6" />
      </div>
      <div class="picker">
        <label><input type="checkbox" id="pressure" checked /> å£“åŠ›æ„Ÿæ‡‰</label>
      </div>
      <div class="sep"></div>
      <button class="btn" id="undo" title="å¾©åŸ (Ctrl+Z)">â†¶ å¾©åŸ</button>
      <button class="btn" id="redo" title="é‡åš (Ctrl+Y)">â†· é‡åš</button>
      <button class="btn" id="clear" title="æ¸…ç©ºçœ‹æ¿">ğŸ—‘ï¸ æ¸…ç©º</button>
      <button class="btn" id="save" title="åŒ¯å‡º PNG">ğŸ’¾ åŒ¯å‡º</button>
    </div>

    <div class="right">
      <button class="btn" id="fullscreen" title="å…¨è¢å¹• (F)">â›¶ å…¨è¢å¹•</button>
      <button class="btn" id="toggleGrid" title="åˆ‡æ›æ ¼ç·š (G)"># æ ¼ç·š</button>
    </div>
  </div>

  <div class="canvas-wrap">
    <div id="grid"></div>
    <canvas id="board"></canvas>
    <div class="text-editor" id="textEditor">
      <textarea id="textInput" placeholder="è¼¸å…¥æ–‡å­—â€¦"></textarea>
      <div class="actions">
        <button class="btn" id="textOk">æ’å…¥</button>
        <button class="btn" id="textCancel">å–æ¶ˆ</button>
      </div>
    </div>
    <div class="hint">å¿«æ·éµï¼š<kbd>P</kbd>ç­† <kbd>H</kbd>è¢å…‰ <kbd>E</kbd>æ“¦ <kbd>L</kbd>ç·š <kbd>R</kbd>çŸ©å½¢ <kbd>T</kbd>æ–‡å­— <kbd>Z</kbd>é›·å°„ï½œ<kbd>Ctrl</kbd>+<kbd>Z</kbd> å¾©åŸ <kbd>Ctrl</kbd>+<kbd>Y</kbd> é‡åšï½œ<kbd>F</kbd> å…¨è¢å¹•</div>
    <div class="toast" id="toast">å·²åŒ¯å‡º PNG æª”</div>
  </div>

  <footer>
    <div>ç•«ç­†æœƒè‡ªå‹•æ ¹æ“š <em>Pointer Events</em> çš„ <code>pressure</code> æ”¹è®Šç²—ç´°ï¼ˆå¯é—œé–‰ï¼‰ã€‚æ”¯æ´è§¸æ§/æ»‘é¼ /æ‰‹å¯«ç­†ã€‚</div>
  </footer>

<script>
/**
 * Digital Whiteboard â€“ å–®æª”ç‰ˆ
 * åŠŸèƒ½ï¼šç•«ç­†ã€è¢å…‰ç­†ã€æ©¡çš®æ“¦ã€ç›´ç·šã€çŸ©å½¢ã€æ–‡å­—ã€é›·å°„ç­†ã€æ’¤éŠ·/é‡åšã€æ ¼ç·šã€åŒ¯å‡º PNGã€å…¨è¢å¹•
 * å¯¦ä½œï¼šä»¥å‘é‡æ“ä½œè¨˜éŒ„ historyï¼Œé‡ç¹ªæ¸²æŸ“ï¼Œé¿å…ä½åœ–å¿«ç…§é€ æˆé«˜è¨˜æ†¶é«”å£“åŠ›ã€‚
 */
const $ = (s)=>document.querySelector(s);

const canvas = $('#board');
const ctx = canvas.getContext('2d');
const grid = $('#grid');

const tools = ['pen','highlighter','eraser','line','rect','text','laser'];
let tool = 'pen';
let color = $('#color').value;
let size = +$('#size').value;
let pressureEnabled = $('#pressure').checked;
let drawing = false;
let startPoint = null; // for line/rect
let tempShape = null;  // preview frame
let laserTrail = [];

const history = []; // vector ops
let redoStack = [];

function resize(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const {clientWidth:w, clientHeight:h} = canvas.parentElement;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w+"px"; canvas.style.height = h+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  render();
}
window.addEventListener('resize', resize);

function setActiveTool(t){
  tool = t; $$('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
}
function $$(s){return Array.from(document.querySelectorAll(s))}

// UI binds
$$('.tool').forEach(b=>b.addEventListener('click',()=>setActiveTool(b.dataset.tool)));
$('#color').addEventListener('input', e=>{color=e.target.value;render()});
$('#size').addEventListener('input', e=>{size=+e.target.value});
$('#pressure').addEventListener('change', e=>{pressureEnabled=e.target.checked});
$('#undo').addEventListener('click', undo);
$('#redo').addEventListener('click', redo);
$('#clear').addEventListener('click', ()=>{history.length=0; redoStack.length=0; render()});
$('#save').addEventListener('click', exportPNG);
$('#fullscreen').addEventListener('click', toggleFullscreen);
$('#toggleGrid').addEventListener('click', ()=>{grid.style.display = grid.style.display==='none' ? '' : 'none'});

// Pointer Events
canvas.addEventListener('pointerdown', onDown);
canvas.addEventListener('pointermove', onMove);
canvas.addEventListener('pointerup', onUp);
canvas.addEventListener('pointercancel', onUp);
canvas.addEventListener('pointerleave', onUp);
canvas.addEventListener('contextmenu', e=>e.preventDefault());

function getPos(e){
  const r = canvas.getBoundingClientRect();
  return {x: e.clientX - r.left, y: e.clientY - r.top, p: e.pressure || 0.5};
}

function onDown(e){
  if(e.button===1) return; // ignore middle
  canvas.setPointerCapture(e.pointerId);
  const pos = getPos(e);
  drawing = true; startPoint = pos; tempShape = null;
  if(tool==='pen' || tool==='highlighter' || tool==='eraser'){
    const stroke = {type: tool, color, size, points:[{x:pos.x,y:pos.y,p:pos.p}]};
    history.push(stroke); redoStack.length=0; render();
  } else if(tool==='laser') {
    laserTrail.push({x:pos.x,y:pos.y,t:performance.now()});
  } else if(tool==='text'){
    openTextEditor(pos.x,pos.y);
    drawing=false; // text via editor
  }
}

function onMove(e){
  const pos = getPos(e);
  if(tool==='laser'){
    laserTrail.push({x:pos.x,y:pos.y,t:performance.now()});
    render();
    return;
  }
  if(!drawing) return;
  if(tool==='pen' || tool==='highlighter' || tool==='eraser'){
    const stroke = history[history.length-1];
    const pressure = pressureEnabled ? Math.max(0.2, pos.p) : 1;
    stroke.points.push({x:pos.x,y:pos.y,p:pressure});
    // ä½¿ç”¨åˆä½µäº‹ä»¶ï¼Œæå‡å¹³æ»‘åº¦
    const coalesced = e.getCoalescedEvents ? e.getCoalescedEvents() : [];
    for(const ce of coalesced){
      const cp = getPos(ce);
      stroke.points.push({x:cp.x,y:cp.y,p: pressureEnabled? Math.max(0.2, cp.p):1});
    }
    render();
  } else if(tool==='line' || tool==='rect'){
    tempShape = {type:tool, start:startPoint, end:pos, color, size};
    render();
  }
}

function onUp(){
  if(!drawing) return;
  drawing = false;
  if(tempShape){
    history.push(tempShape); redoStack.length=0; tempShape=null; render();
  }
}

// Drawing
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // draw all ops
  for(const op of history){
    drawOp(op, ctx);
  }
  // preview temp
  if(tempShape){ drawOp(tempShape, ctx, true); }
  // laser trail (not persistent)
  drawLaser();
}

function drawOp(op, c, preview=false){
  if(op.type==='pen' || op.type==='highlighter' || op.type==='eraser'){
    c.save();
    c.lineJoin='round'; c.lineCap='round';
    c.globalCompositeOperation = (op.type==='eraser')? 'destination-out':'source-over';
    c.globalAlpha = (op.type==='highlighter')? 0.28 : 1;
    c.strokeStyle = (op.type==='eraser')? '#000' : op.color;
    c.beginPath();
    for(let i=1;i<op.points.length;i++){
      const a = op.points[i-1], b = op.points[i];
      const w = (op.size) * (pressureEnabled ? (b.p||1) : 1);
      c.lineWidth = Math.max(0.5, w);
      c.moveTo(a.x,a.y); c.lineTo(b.x,b.y);
    }
    c.stroke();
    c.restore();
  }
  if(op.type==='line'){
    c.save(); c.strokeStyle = op.color; c.lineWidth = op.size; c.lineCap='round';
    c.beginPath(); c.moveTo(op.start.x, op.start.y); c.lineTo(op.end.x, op.end.y); c.stroke(); c.restore();
  }
  if(op.type==='rect'){
    c.save(); c.strokeStyle = op.color; c.lineWidth = op.size;
    const x = Math.min(op.start.x, op.end.x);
    const y = Math.min(op.start.y, op.end.y);
    const w = Math.abs(op.start.x - op.end.x);
    const h = Math.abs(op.start.y - op.end.y);
    c.strokeRect(x,y,w,h); c.restore();
  }
  if(op.type==='text'){
    c.save(); c.fillStyle = op.color; c.font = `${op.size||28}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto`;
    wrapText(c, op.text, op.x, op.y, 800, 1.35*(op.size||28));
    c.restore();
  }
}

function drawLaser(){
  const now = performance.now();
  const life = 600; // ms
  laserTrail = laserTrail.filter(p=> now - p.t < life);
  const c = ctx; c.save();
  for(const p of laserTrail){
    const k = 1 - (now - p.t)/life;
    c.globalAlpha = Math.max(0, k);
    c.fillStyle = '#ef4444';
    c.beginPath(); c.arc(p.x,p.y,10*k,0,Math.PI*2); c.fill();
  }
  c.restore();
  if(laserTrail.length) requestAnimationFrame(render);
}

// text editor
const editor = $('#textEditor');
const textInput = $('#textInput');
$('#textOk').addEventListener('click', ()=>{
  const text = textInput.value.trim();
  if(text){
    history.push({type:'text', text, x: editor.dataset.x|0, y: editor.dataset.y|0, color, size: Math.max(16, size)});
    redoStack.length=0; render();
  }
  closeTextEditor();
});
$('#textCancel').addEventListener('click', closeTextEditor);

function openTextEditor(x,y){
  editor.style.left = x + 'px';
  editor.style.top = y + 'px';
  editor.dataset.x = x; editor.dataset.y = y;
  editor.style.display = 'block';
  textInput.value=''; textInput.focus();
}
function closeTextEditor(){ editor.style.display='none'; }

// helpers
function undo(){ if(history.length){ redoStack.push(history.pop()); render(); } }
function redo(){ if(redoStack.length){ history.push(redoStack.pop()); render(); } }
function toggleFullscreen(){ if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } else { document.exitFullscreen?.(); } }
function exportPNG(){
  // å°‡æ ¼ç·šæš«æ™‚éš±è—ï¼Œé¿å…çƒ™å°åœ¨è¼¸å‡º
  const wasHidden = grid.style.display==='none';
  grid.style.display='none';
  render();
  requestAnimationFrame(()=>{
    const a = document.createElement('a'); a.download='whiteboard.png';
    a.href = canvas.toDataURL('image/png'); a.click();
    grid.style.display = wasHidden? 'none' : '';
    showToast('å·²åŒ¯å‡º PNG æª”'); render();
  });
}
function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }

function wrapText(c, text, x, y, maxWidth, lineHeight){
  const words = text.split(/\s+/); let line=''; let yy=y;
  for(let n=0;n<words.length;n++){
    const test = line + (line?' ':'') + words[n];
    const w = c.measureText(test).width;
    if(w>maxWidth && n>0){ c.fillText(line, x, yy); line = words[n]; yy+=lineHeight; }
    else line = test;
  }
  c.fillText(line, x, yy);
}

// keyboard shortcuts
window.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
  else if(e.ctrlKey && e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); }
  else if(e.key.toLowerCase()==='f'){ toggleFullscreen(); }
  else {
    const keyMap = {p:'pen', h:'highlighter', e:'eraser', l:'line', r:'rect', t:'text', z:'laser'};
    const t = keyMap[e.key.toLowerCase()]; if(t){ setActiveTool(t); }
  }
});

// init
setActiveTool('pen');
resize();

</script>
</body>
</html>

<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Digital Whiteboard(æ¸¬è©¦ç‰ˆ)</title>
<style>
:root{--bg:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--primary:#22d3ee;--accent:#a78bfa;--warn:#fb7185}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 50% -200px,#1e293b,#0f172a);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;display:flex;flex-direction:column;overflow:hidden}
.header{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid #1f2937;background:linear-gradient(#0b1220,#0b1220f2)}
.logo{font-weight:800}
.badge{font-size:12px;padding:4px 8px;border:1px solid #334155;border-radius:999px;color:var(--muted)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;box-shadow:0 2px 0 #00000055;user-select:none}
.btn:hover{filter:brightness(1.12)}
.btn.active{outline:2px solid var(--primary)}
label{font-size:12px;color:var(--muted)}
.picker{display:flex;gap:6px;align-items:center}
.sep{width:1px;height:28px;background:#243041;margin:0 6px}
.right{margin-left:auto;display:flex;gap:8px;align-items:center}

.canvas-wrap{position:relative;flex:1;overflow:hidden}
#board{position:absolute;inset:0;touch-action:none;cursor:crosshair}
#grid{position:absolute;inset:0;pointer-events:none;opacity:.3;background-size:40px 40px;background-image:linear-gradient(to right,#1f2937 1px,transparent 1px),linear-gradient(to bottom,#1f2937 1px,transparent 1px)}
.guides{position:absolute;inset:0;pointer-events:none}
.guide{position:absolute;background:#ef4444}
.guide.v{width:2px;top:0;bottom:0}
.guide.h{height:2px;left:0;right:0}
.hint{position:absolute;left:12px;bottom:12px;color:var(--muted);background:#0b1220cc;border:1px solid #1f2937;border-radius:10px;padding:8px 10px;backdrop-filter:blur(6px);font-size:13px}
.toast{position:absolute;top:16px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #1f2937;border-radius:12px;padding:10px 14px;opacity:0;transition:opacity .25s ease}
.toast.show{opacity:1}

/* æ¸¸æ¨™ç‹€æ…‹ */
.cursor-move{cursor:move!important}
.cursor-rotate{cursor:grab!important}
.cursor-nwse{cursor:nwse-resize!important}
.cursor-nesw{cursor:nesw-resize!important}
.cursor-ns{cursor:ns-resize!important}
.cursor-ew{cursor:ew-resize!important}

/* æµ®å‹•æ–‡å­—ç·¨è¼¯å™¨ */
.text-editor{position:absolute;z-index:10;display:none}
.text-editor textarea{min-width:320px;min-height:100px;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:#e5e7eb;font-size:20px;line-height:1.4}
.text-editor .actions{margin-top:6px;display:flex;gap:6px}
</style>
</head>
<body>
  <div class="header">
    <div class="logo">Digital Whiteboard</div>
    <span class="badge">Developed by DennisZ</span>

    <div class="toolbar">
      <button class="btn tool" data-tool="select" title="é¸å–/ç·¨è¼¯ (S)">ğŸ–±ï¸ é¸å–</button>
      <button class="btn tool" data-tool="pen" title="ç•«ç­† (P)">âœï¸ ç•«ç­†</button>
      <button class="btn tool" data-tool="highlighter" title="è¢å…‰ç­† (H)">ğŸ–ï¸ è¢å…‰ç­†</button>
      <button class="btn tool" data-tool="eraser" title="æ©¡çš®æ“¦ (E)">ğŸ§½ æ©¡çš®æ“¦</button>
      <div class="sep"></div>
      <button class="btn tool" data-tool="line" title="ç›´ç·š (L)">ğŸ“ ç›´ç·š</button>
      <button class="btn tool" data-tool="rect" title="çŸ©å½¢ (R)">â–­ çŸ©å½¢</button>
      <button class="btn tool" data-tool="text" title="æ–‡å­— (T)">ğŸ”¤ æ–‡å­—</button>
      <button class="btn tool" data-tool="laser" title="é›·å°„ç­† (Z)">ğŸ”´ é›·å°„</button>
      <div class="sep"></div>
      <div class="picker"><label>é¡è‰²</label><input type="color" id="color" value="#e5e7eb"></div>
      <div class="picker"><label>ç²—ç´°</label><input type="range" id="size" min="1" max="60" value="6"></div>
      <div class="picker"><label><input type="checkbox" id="pressure" checked> å£“åŠ›æ„Ÿæ‡‰</label></div>
      <div class="sep"></div>
      <button class="btn" id="keepRatio" title="ç­‰æ¯”/éç­‰æ¯”åˆ‡æ› (é è¨­ç­‰æ¯”)">ğŸ”’ ç­‰æ¯”</button>
      <div class="picker"><label><input type="checkbox" id="snapGrid" checked> å¸é™„æ ¼ç·š</label></div>
      <div class="picker"><label><input type="checkbox" id="snapObjects" checked> å¸é™„ç‰©ä»¶</label></div>
      <div class="sep"></div>
      <button class="btn" id="undo" title="å¾©åŸ (Ctrl+Z)">â†¶ å¾©åŸ</button>
      <button class="btn" id="redo" title="é‡åš (Ctrl+Y)">â†· é‡åš</button>
      <button class="btn" id="clear" title="æ¸…ç©ºçœ‹æ¿">ğŸ—‘ï¸ æ¸…ç©º</button>
      <button class="btn" id="save" title="åŒ¯å‡º PNG">ğŸ’¾ åŒ¯å‡º</button>
      <div class="sep"></div>
      <button class="btn" id="pasteBtn" title="è²¼ä¸Šå‰ªè²¼ç°¿ (Ctrl+V)">ğŸ“‹ è²¼ä¸Š</button>
      <button class="btn" id="lockToggle" title="é–å®š/è§£é–å·²é¸å–ç‰©ä»¶">ğŸ”’ é–å®š/è§£é–</button>
      <div class="sep"></div>
      <button class="btn" id="bringFront" title="ç§»åˆ°æœ€å‰">â¬†ï¸ æœ€å‰</button>
      <button class="btn" id="sendBack" title="ç§»åˆ°æœ€å¾Œ">â¬‡ï¸ æœ€å¾Œ</button>
      <button class="btn" id="stepForward" title="å¾€å‰ä¸€å±¤">ğŸ”¼ å‰ç§»</button>
      <button class="btn" id="stepBackward" title="å¾€å¾Œä¸€å±¤">ğŸ”½ å¾Œç§»</button>
    </div>

    <div class="right">
      <button class="btn" id="fullscreen" title="å…¨è¢å¹• (F)">â›¶ å…¨è¢å¹•</button>
      <button class="btn" id="toggleGrid" title="åˆ‡æ›æ ¼ç·š (G)"># æ ¼ç·š</button>
    </div>
  </div>

  <div class="canvas-wrap">
    <div id="grid"></div>
    <canvas id="board"></canvas>
    <div class="guides" id="guides"></div>

    <div class="text-editor" id="textEditor">
      <textarea id="textInput" placeholder="è¼¸å…¥æ–‡å­—â€¦"></textarea>
      <div class="actions">
        <button class="btn" id="textOk">æ’å…¥</button>
        <button class="btn" id="textCancel">å–æ¶ˆ</button>
      </div>
    </div>

    <div class="hint">S é¸å–ï¼æ¡†é¸ï¼ˆæ‹–æ›³ç©ºç™½ï¼‰ï½œShift å¤šé¸ï½œCtrl+D è¤‡è£½ï½œShift+ç¸®æ”¾ï¼ç­‰æ¯”ï¼ˆæˆ–æŒ‰ã€ŒğŸ”’ ç­‰æ¯”ã€ï¼‰ï½œCtrl+V è²¼ä¸Šæ–‡å­—/åœ–ç‰‡ï½œå¸é™„ï¼šæ ¼ç·š/ç‰©ä»¶</div>
    <div class="toast" id="toast">å·²åŒ¯å‡º PNG æª”</div>
  </div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const canvas=$('#board'), ctx=canvas.getContext('2d');
const gridEl=$('#grid'), guidesEl=$('#guides');

// å·¥å…·èˆ‡ç‹€æ…‹
const tools=['select','pen','highlighter','eraser','line','rect','text','laser'];
let tool='select', color=$('#color').value, size=+$('#size').value, pressureEnabled=$('#pressure').checked;
let keepRatio=true; $('#keepRatio').classList.add('active');
let snapGrid=true, snapObjects=true; const GRID=40, SNAP_N=8; // å¸é™„é–¾å€¼

// ç•«å¸ƒ/ç¹ªåœ–
let drawing=false, startPoint=null, tempShape=null, laserTrail=[];
const history=[]; let redoStack=[];

// ç‰©ä»¶å±¤ï¼ˆå¯ç§»å‹•/ç¸®æ”¾/æ—‹è½‰/é–å®š/åœ–å±¤/è²¼ä¸Šï¼‰
const objects=[]; // {type:'image'|'textblock', x,y,w,h, rot, img?, text?, color?, size?, locked:false}
let selection=[]; // å¤šé¸ index é™£åˆ—
let dragMode=null; // 'move'|'resize'|'rotate'|'marquee'
let activeHandle=-1; // -1=æœ¬é«”, 0..7=é‚Š/è§’, 8=æ—‹è½‰
let dragDX=0, dragDY=0; let marquee=null; // {x,y,w,h}

// ===== åˆå§‹åŒ–å°ºå¯¸ =====
function resize(){ const dpr=Math.max(1,window.devicePixelRatio||1); const {clientWidth:w,clientHeight:h}=canvas.parentElement; canvas.width=w*dpr; canvas.height=h*dpr; canvas.style.width=w+'px'; canvas.style.height=h+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); render();}
window.addEventListener('resize',resize); resize();

function setActiveTool(t){ tool=t; $$('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t)); canvas.style.cursor = (t==='select'?'default':'crosshair'); }
$$('.tool').forEach(b=>b.addEventListener('click',()=>setActiveTool(b.dataset.tool)));
$('#color').addEventListener('input',e=>{color=e.target.value; render()});
$('#size').addEventListener('input',e=>{size=+e.target.value});
$('#pressure').addEventListener('change',e=>{pressureEnabled=e.target.checked});
$('#keepRatio').addEventListener('click',()=>{ keepRatio=!keepRatio; $('#keepRatio').classList.toggle('active',keepRatio); $('#keepRatio').textContent = keepRatio? 'ğŸ”’ ç­‰æ¯”':'ğŸ”“ éç­‰æ¯”';});
$('#snapGrid').addEventListener('change',e=>{snapGrid=e.target.checked});
$('#snapObjects').addEventListener('change',e=>{snapObjects=e.target.checked});
$('#toggleGrid').addEventListener('click',()=>{ gridEl.style.display = gridEl.style.display==='none'? '':'none'; });
$('#fullscreen').addEventListener('click',()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen?.(); else document.exitFullscreen?.(); });
$('#undo').addEventListener('click',()=>{ if(history.length){redoStack.push(history.pop()); render();}});
$('#redo').addEventListener('click',()=>{ if(redoStack.length){history.push(redoStack.pop()); render();}});
$('#clear').addEventListener('click',()=>{ history.length=0; redoStack.length=0; objects.length=0; selection.length=0; render(); });
$('#save').addEventListener('click',exportPNG);
$('#pasteBtn').addEventListener('click',pasteFromClipboard);
$('#lockToggle').addEventListener('click',()=>{ if(!selection.length) return; for(const i of selection){ objects[i].locked = !objects[i].locked; } render(); });
$('#bringFront').addEventListener('click',()=>{ if(!selection.length) return; selection.sort((a,b)=>a-b); const moved=[]; for(let i=0;i<selection.length;i++){ const idx=selection[i]-i; moved.push(objects.splice(idx,1)[0]); } moved.forEach(o=>objects.push(o)); selection = moved.map((_,i)=>objects.length - moved.length + i); render(); });
$('#sendBack').addEventListener('click',()=>{ if(!selection.length) return; selection.sort((a,b)=>a-b); const moved=selection.map((idx,i)=>objects.splice(idx-i,1)[0]); objects.unshift(...moved); selection = moved.map((_,i)=>i); render(); });
$('#stepForward').addEventListener('click',()=>{ if(!selection.length) return; selection.sort((a,b)=>b-a); for(const idx of selection){ if(idx<objects.length-1){ [objects[idx],objects[idx+1]]=[objects[idx+1],objects[idx]]; } } selection = selection.map(i=>Math.min(i+1,objects.length-1)); render(); });
$('#stepBackward').addEventListener('click',()=>{ if(!selection.length) return; selection.sort((a,b)=>a-b); for(const idx of selection){ if(idx>0){ [objects[idx],objects[idx-1]]=[objects[idx-1],objects[idx]]; } } selection = selection.map(i=>Math.max(i-1,0)); render(); });

// ===== æŒ‡æ¨™äº‹ä»¶ =====
canvas.addEventListener('pointerdown',onDown); canvas.addEventListener('pointermove',onMove); canvas.addEventListener('pointerup',onUp); canvas.addEventListener('pointercancel',onUp); canvas.addEventListener('pointerleave',onUp); canvas.addEventListener('contextmenu',e=>e.preventDefault());
function getPos(e){ const r=canvas.getBoundingClientRect(); return {x:e.clientX-r.left, y:e.clientY-r.top, p:e.pressure||0.5}; }

function onDown(e){ const p=getPos(e); if(tool==='select'){
  const hit = hitTest(p.x,p.y,true); // æ”¯æ´æŠŠæ‰‹å‘½ä¸­
  if(hit){
    if(e.shiftKey){ toggleSelection(hit.index); } else { if(!selection.includes(hit.index)) selection=[hit.index]; }
    activeHandle = hit.handle; updateCursorByHandle(activeHandle);
    if(activeHandle===-1){ dragMode='move'; const c=getGroupCenter(); dragDX=p.x - c.x; dragDY=p.y - c.y; }
    else if(activeHandle===8){ dragMode='rotate'; }
    else { dragMode='resize'; }
    render(); return;
  }
  // ç©ºç™½è™• â†’ æ¡†é¸ï¼ˆmarqueeï¼‰
  dragMode='marquee'; marquee={x:p.x,y:p.y,w:0,h:0}; selection=[]; render(); return;
 }
 // å…¶é¤˜å·¥å…·ï¼šé€²å…¥ç¹ªç•«
 drawing=true; startPoint=p; tempShape=null;
 if(['pen','highlighter','eraser'].includes(tool)){
   const stroke={type:tool,color,size,points:[{x:p.x,y:p.y,p:p.p}]}; history.push(stroke); redoStack.length=0; render();
 } else if(tool==='line' || tool==='rect'){
   tempShape={type:tool,start:p,end:p,color,size}; render();
 } else if(tool==='text'){
   openTextEditor(p.x,p.y); drawing=false;
 } else if(tool==='laser'){
   laserTrail.push({x:p.x,y:p.y,t:performance.now()});
 }
}

function onMove(e){ const p=getPos(e);
 // æŒ‡æ¨™å½¢ç‹€ï¼ˆåƒ… select æ™‚ï¼‰
 if(tool==='select' && !dragMode){ const hover = hitTest(p.x,p.y,true); updateCursorByHandle(hover?hover.handle:null); }

 if(tool==='select'){
   if(dragMode==='move'){
     const c=getGroupCenter(); const nx=p.x - dragDX, ny=p.y - dragDY; const dx=nx-c.x, dy=ny-c.y; translateSelection(dx,dy,true/*snap*/); render(); return;
   }
   if(dragMode==='rotate'){
     const c=getGroupCenter(); const a0=Math.atan2(p.y-c.y, p.x-c.x); setGroupRotation(a0); render(); return;
   }
   if(dragMode==='resize'){
     resizeSelectionByHandle(activeHandle,p.x,p.y,keepRatio && !e.altKey); render(); return;
   }
   if(dragMode==='marquee'){
     marquee.w=p.x-marquee.x; marquee.h=p.y-marquee.y; selection = rangeSelect(marquee); render(); return;
   }
 }
 // ç¹ªç•«å·¥å…·
 if(tool==='laser'){ laserTrail.push({x:p.x,y:p.y,t:performance.now()}); render(); return; }
 if(!drawing) return;
 if(['pen','highlighter','eraser'].includes(tool)){
   const stroke=history[history.length-1]; const pr=pressureEnabled?Math.max(0.2,p.p):1; stroke.points.push({x:p.x,y:p.y,p:pr});
   const coalesced=e.getCoalescedEvents?e.getCoalescedEvents():[]; for(const ce of coalesced){ const cp=getPos(ce); stroke.points.push({x:cp.x,y:cp.y,p:pressureEnabled?Math.max(0.2,cp.p):1}); }
   render();
 } else if(tool==='line' || tool==='rect'){
   tempShape.end=p; render();
 }
}

function onUp(){ if(dragMode){ dragMode=null; marquee=null; clearGuides(); return; } if(!drawing) return; drawing=false; if(tempShape){ history.push(tempShape); redoStack.length=0; tempShape=null; render(); } }

// ====== ç‰©ä»¶è™•ç† ======
function hitTest(x,y,withHandles=false){ // ç”±ä¸Šå±¤å¾€ä¸‹æ‰¾
 for(let i=objects.length-1;i>=0;i--){ const o=objects[i]; const local=toLocal(o,x,y); const halfX=o.w/2, halfY=o.h/2;
  // æŠŠæ‰‹ï¼ˆå–®é¸æ™‚ï¼‰
  if(withHandles && selection.length===1 && selection[0]===i){ const h=handleHit(local,o); if(h!==null){ return {index:i, handle:h}; } }
  if(local.x>=-halfX && local.x<=halfX && local.y>=-halfY && local.y<=halfY){ return {index:i, handle:-1}; }
 }
 // ç¾¤çµ„æŠŠæ‰‹ï¼ˆå¤šé¸ï¼‰
 if(withHandles && selection.length>1){ const b=getGroupBounds(); const local = {x:x-b.x-b.w/2, y:y-b.y-b.h/2}; const h=groupHandleHit(local,b); if(h!==null) return {index:selection[selection.length-1], handle:h}; }
 return null; }

function handleHit(local,o){ const s=10, b={w:o.w,h:o.h}; const pts=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]]; // 0..7
 for(let i=0;i<8;i++){ const px=pts[i][0]*b.w/2, py=pts[i][1]*b.h/2; if(Math.abs(local.x-px)<=s && Math.abs(local.y-py)<=s){ return i; } }
 // æ—‹è½‰æŠŠæ‰‹ï¼ˆä¸Šæ–¹ï¼‰ index=8
 if(Math.abs(local.x)<=12 && Math.abs(local.y + (b.h/2 + 36))<=12) return 8;
 return null; }
function groupHandleHit(local,b){ const s=10; const pts=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]]; for(let i=0;i<8;i++){ const px=pts[i][0]*b.w/2, py=pts[i][1]*b.h/2; if(Math.abs(local.x-px)<=s && Math.abs(local.y-py)<=s){ return i; } } if(Math.abs(local.x)<=12 && Math.abs(local.y + (b.h/2 + 36))<=12) return 8; return null; }

function toLocal(o,x,y){ const s=Math.sin(-(o.rot||0)), c=Math.cos(-(o.rot||0)); const dx=x-o.x, dy=y-o.y; return {x: dx*c - dy*s, y: dx*s + dy*c}; }

function toggleSelection(idx){ const i=selection.indexOf(idx); if(i>=0) selection.splice(i,1); else selection.push(idx); }
function rangeSelect(m){ const x1=Math.min(m.x,m.x+m.w), y1=Math.min(m.y,m.y+m.h), x2=Math.max(m.x,m.x+m.w), y2=Math.max(m.y,m.y+m.h); const hits=[]; for(let i=0;i<objects.length;i++){ const o=objects[i]; const bx=o.x-o.w/2, by=o.y-o.h/2, bw=o.w, bh=o.h; if(bx>=x1 && by>=y1 && bx+bw<=x2 && by+bh<=y2) hits.push(i); } return hits; }

function getGroupBounds(){ if(!selection.length){ return {x:0,y:0,w:0,h:0}; } let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; for(const i of selection){ const o=objects[i]; minX=Math.min(minX,o.x-o.w/2); minY=Math.min(minY,o.y-o.h/2); maxX=Math.max(maxX,o.x+o.w/2); maxY=Math.max(maxY,o.y+o.h/2); } return {x:(minX+maxX)/2, y:(minY+maxY)/2, w:maxX-minX, h:maxY-minY}; }
function getGroupCenter(){ const b=getGroupBounds(); return {x:b.x, y:b.y}; }

function translateSelection(dx,dy,doSnap){ if(!selection.length) return; clearGuides(); let ndx=dx, ndy=dy; if(doSnap){ const guide = snapDelta(dx,dy); ndx+=guide.dx; ndy+=guide.dy; drawGuides(guide); }
 for(const i of selection){ const o=objects[i]; if(o.locked) continue; o.x+=ndx; o.y+=ndy; }
}
function setGroupRotation(a){ for(const i of selection){ const o=objects[i]; if(o.locked) continue; o.rot=a; } }

function resizeSelectionByHandle(handle,gx,gy,lockRatio){ const b=getGroupBounds(); const cx=b.x, cy=b.y; const ox=gx-cx, oy=gy-cy; // ç¾¤çµ„ä»¥è»¸å°é½Šæ¡†
 let nx=b.w, ny=b.h; const min=24;
 if(handle===1||handle===6){ ny=Math.max(min, Math.abs(oy)*2); if(lockRatio){ nx=Math.max(min, ny*(b.w/b.h)); } }
 else if(handle===3||handle===4){ nx=Math.max(min, Math.abs(ox)*2); if(lockRatio){ ny=Math.max(min, nx*(b.h/b.w)); } }
 else{ nx=Math.max(min, Math.abs(ox)*2); ny=Math.max(min, Math.abs(oy)*2); if(lockRatio){ const r=b.w/b.h; if(nx/ny>r) ny=nx/r; else nx=ny*r; } }
 const sx=nx/b.w, sy=ny/b.h; // scale
 for(const i of selection){ const o=objects[i]; if(o.locked) continue; const rx=o.x - cx, ry=o.y - cy; o.x = cx + rx*sx; o.y = cy + ry*sy; o.w = Math.max(min, o.w*sx); o.h = Math.max(min, o.h*sy); }
}

// ====== å¸é™„ & å°å¼•ç·š ======
function snapDelta(dx,dy){ // å›å‚³ {dx,dy, guides: [...]}ï¼Œä»¥ç¾¤çµ„ä¸­å¿ƒç‚ºåŸºæº–
 const guides=[]; let fixDX=0, fixDY=0; const c=getGroupCenter();
 // 1) å°é½Šæ ¼ç·š
 if(snapGrid){ const tx=c.x+dx, ty=c.y+dy; const gx=Math.round(tx/GRID)*GRID, gy=Math.round(ty/GRID)*GRID; if(Math.abs(gx-tx)<=SNAP_N){ fixDX+=(gx-tx); guides.push({type:'v', x:gx}); } if(Math.abs(gy-ty)<=SNAP_N){ fixDY+=(gy-ty); guides.push({type:'h', y:gy}); } }
 // 2) å°é½Šå…¶ä»–ç‰©ä»¶çš„é‚Šèˆ‡ä¸­å¿ƒ
 if(snapObjects){ const allX=[], allY=[]; for(let i=0;i<objects.length;i++){ if(selection.includes(i)) continue; const o=objects[i]; allX.push(o.x-o.w/2, o.x, o.x+o.w/2); allY.push(o.y-o.h/2, o.y, o.y+o.h/2); }
   const tx=c.x+dx+fixDX, ty=c.y+dy+fixDY; const gb=getGroupBounds(); const xs=[tx - gb.w/2, tx, tx + gb.w/2]; const ys=[ty - gb.h/2, ty, ty + gb.h/2];
   let bestX=null, bestDX=Infinity; for(const xv of xs){ for(const ex of allX){ const d=ex-xv; if(Math.abs(d)<=SNAP_N && Math.abs(d)<Math.abs(bestDX)){ bestDX=d; bestX=ex; } } }
   let bestY=null, bestDY=Infinity; for(const yv of ys){ for(const ey of allY){ const d=ey-yv; if(Math.abs(d)<=SNAP_N && Math.abs(d)<Math.abs(bestDY)){ bestDY=d; bestY=ey; } } }
   if(bestX!==null){ fixDX+=bestDX; guides.push({type:'v', x:bestX}); }
   if(bestY!==null){ fixDY+=bestDY; guides.push({type:'h', y:bestY}); }
 }
 return {dx:fixDX, dy:fixDY, guides};
}
function drawGuides(info){ clearGuides(); if(!info||!info.guides) return; for(const g of info.guides){ const el=document.createElement('div'); el.className='guide '+(g.type==='v'?'v':'h'); if(g.type==='v'){ el.style.left=g.x+'px'; } else { el.style.top=g.y+'px'; } guidesEl.appendChild(el); } }
function clearGuides(){ guidesEl.innerHTML=''; }

// ====== æ¸²æŸ“ ======
function render(){ ctx.clearRect(0,0,canvas.width,canvas.height);
 // æ­·å²å‘é‡
 for(const op of history){ drawOp(op); }
 // ç‰©ä»¶
 for(let i=0;i<objects.length;i++){ drawObject(objects[i]); }
 // æš«å­˜å½¢ç‹€
 if(tempShape) drawOp(tempShape,true);
 // æ¡†é¸
 if(marquee){ ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='#22d3ee'; ctx.strokeRect(marquee.x,marquee.y,marquee.w,marquee.h); ctx.restore(); }
 // é¸å–æ¡†
 if(selection.length){ drawSelectionBox(); }
 // é›·å°„
 drawLaser();
}

function drawOp(op,preview=false){ if(['pen','highlighter','eraser'].includes(op.type)){ ctx.save(); ctx.lineJoin='round'; ctx.lineCap='round'; ctx.globalCompositeOperation=(op.type==='eraser')?'destination-out':'source-over'; ctx.globalAlpha=(op.type==='highlighter')?0.28:1; ctx.strokeStyle=(op.type==='eraser')?'#000':op.color; ctx.beginPath(); for(let i=1;i<op.points.length;i++){ const a=op.points[i-1], b=op.points[i]; const w=(op.size)*(pressureEnabled?(b.p||1):1); ctx.lineWidth=Math.max(0.5,w); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); } ctx.stroke(); ctx.restore(); }
 else if(op.type==='line'){ ctx.save(); ctx.strokeStyle=op.color; ctx.lineWidth=op.size; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(op.start.x,op.start.y); ctx.lineTo(op.end.x,op.end.y); ctx.stroke(); ctx.restore(); }
 else if(op.type==='rect'){ ctx.save(); ctx.strokeStyle=op.color; ctx.lineWidth=op.size; const x=Math.min(op.start.x,op.end.x), y=Math.min(op.start.y,op.end.y), w=Math.abs(op.start.x-op.end.x), h=Math.abs(op.start.y-op.end.y); ctx.strokeRect(x,y,w,h); ctx.restore(); }
 else if(op.type==='text'){ ctx.save(); ctx.fillStyle=op.color; ctx.font=`${op.size||28}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto`; wrapText(ctx,op.text,op.x,op.y,800,1.35*(op.size||28)); ctx.restore(); } }

function drawObject(o){ ctx.save(); ctx.translate(o.x,o.y); ctx.rotate(o.rot||0); if(o.type==='image'&&o.img){ ctx.drawImage(o.img,-o.w/2,-o.h/2,o.w,o.h);} if(o.type==='textblock'){ ctx.fillStyle=o.color||'#e5e7eb'; ctx.font=`${o.size||24}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto`; wrapText(ctx,o.text,-o.w/2, -o.h/2 + (o.size||24), o.w, 1.35*(o.size||24)); } ctx.restore(); }

function drawSelectionBox(){ const b=getGroupBounds(); ctx.save(); ctx.translate(b.x,b.y); ctx.setLineDash([6,6]); ctx.strokeStyle='#22d3ee'; ctx.lineWidth=2; ctx.strokeRect(-b.w/2,-b.h/2,b.w,b.h); ctx.setLineDash([]);
 // handles 8 + rotate
 const hs=10; const pts=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[ -1,1],[0,1],[1,1]]; for(let i=0;i<8;i++){ const px=pts[i][0]*b.w/2, py=pts[i][1]*b.h/2; ctx.fillStyle='#111827'; ctx.fillRect(px-hs/2,py-hs/2,hs,hs); ctx.strokeStyle='#e5e7eb'; ctx.strokeRect(px-hs/2,py-hs/2,hs,hs); }
 ctx.beginPath(); ctx.moveTo(0,-b.h/2); ctx.lineTo(0,-b.h/2-24); ctx.strokeStyle='#e5e7eb'; ctx.stroke(); ctx.beginPath(); ctx.arc(0,-b.h/2-36,8,0,Math.PI*2); ctx.fillStyle='#111827'; ctx.fill(); ctx.strokeStyle='#e5e7eb'; ctx.stroke(); ctx.restore(); }

// ====== æ¸¸æ¨™ ======
function updateCursorByHandle(h){ canvas.classList.remove('cursor-move','cursor-rotate','cursor-nwse','cursor-nesw','cursor-ns','cursor-ew'); if(h===null||h===undefined){ canvas.style.cursor='default'; return; } if(h===-1){ canvas.classList.add('cursor-move'); return; } if(h===8){ canvas.classList.add('cursor-rotate'); return; } const map={0:'cursor-nwse',2:'cursor-nwse',7:'cursor-nwse',5:'cursor-nwse',1:'cursor-ns',6:'cursor-ns',3:'cursor-ew',4:'cursor-ew'}; const cls=map[h]||'cursor-nwse'; canvas.classList.add(cls); }

// ====== æ–‡å­—ç·¨è¼¯å™¨ ======
const editor=$('#textEditor'), textInput=$('#textInput');
$('#textOk').addEventListener('click',()=>{ const text=textInput.value.trim(); if(text){ history.push({type:'text', text, x: editor.dataset.x|0, y: editor.dataset.y|0, color, size: Math.max(16, size)}); redoStack.length=0; render(); } closeTextEditor(); });
$('#textCancel').addEventListener('click', closeTextEditor);
function openTextEditor(x,y){ editor.style.left=x+'px'; editor.style.top=y+'px'; editor.style.display='block'; editor.dataset.x=x; editor.dataset.y=y; textInput.value=''; textInput.focus(); }
function closeTextEditor(){ editor.style.display='none'; }

// ====== è²¼ä¸Šï¼ˆæ–‡å­—/åœ–ç‰‡ï¼‰ ======
window.addEventListener('paste', handlePaste);
async function pasteFromClipboard(){ try{ if(navigator.clipboard && navigator.clipboard.read){ const items=await navigator.clipboard.read(); for(const it of items){ for(const t of it.types){ if(t.startsWith('image/')){ const blob=await it.getType(t); const img=new Image(); const url=URL.createObjectURL(blob); img.onload=()=>{ const w=Math.min(600,img.width), h=w*(img.height/img.width); objects.push({type:'image',img,x:160,y:140,w,h,rot:0,locked:false}); selection=[objects.length-1]; URL.revokeObjectURL(url); render(); }; img.src=url; return; } } } const text=await navigator.clipboard.readText(); if(text){ objects.push({type:'textblock',text,x:160,y:140,w:600,h:120,rot:0,color, size: Math.max(18,size),locked:false}); selection=[objects.length-1]; render(); return; } } alert('ç„¡æ³•ç›´æ¥è®€å–å‰ªè²¼ç°¿ï¼Œè«‹ç”¨ Ctrl+Vã€‚'); }catch(err){ console.warn(err); alert('è®€å–å‰ªè²¼ç°¿å¤±æ•—ï¼Œè«‹æ”¹ç”¨ Ctrl+Vã€‚'); }}
function handlePaste(e){ const cd=e.clipboardData; if(!cd) return; for(const it of cd.items){ if(it.type && it.type.startsWith('image/')){ const file=it.getAsFile(); const img=new Image(); const url=URL.createObjectURL(file); img.onload=()=>{ const w=Math.min(600,img.width), h=w*(img.height/img.width); objects.push({type:'image',img,x:160,y:140,w,h,rot:0,locked:false}); selection=[objects.length-1]; URL.revokeObjectURL(url); render(); }; img.src=url; e.preventDefault(); return; } } const text=cd.getData('text/plain'); if(text){ objects.push({type:'textblock',text,x:160,y:140,w:600,h:120,rot:0,color, size: Math.max(18,size),locked:false}); selection=[objects.length-1]; render(); e.preventDefault(); } }

// ====== å¯¦ç”¨å‡½å¼ ======
function wrapText(c,text,x,y,maxWidth,lineHeight){ const words=String(text).split(/\s+/); let line=''; let yy=y; for(let n=0;n<words.length;n++){ const t=line+(line?' ':'')+words[n]; const w=c.measureText(t).width; if(w>maxWidth && n>0){ c.fillText(line,x,yy); line=words[n]; yy+=lineHeight; } else line=t; } c.fillText(line,x,yy); }
function exportPNG(){ const wasHidden=gridEl.style.display==='none'; gridEl.style.display='none'; render(); requestAnimationFrame(()=>{ const a=document.createElement('a'); a.download='whiteboard.png'; a.href=canvas.toDataURL('image/png'); a.click(); gridEl.style.display=wasHidden?'none':''; render(); }); }
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

// ====== é›·å°„ ======
function drawLaser(){ const now=performance.now(); const life=600; laserTrail=laserTrail.filter(p=>now-p.t<life); ctx.save(); for(const p of laserTrail){ const k=1-(now-p.t)/life; ctx.globalAlpha=Math.max(0,k); ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(p.x,p.y,10*k,0,Math.PI*2); ctx.fill(); } ctx.restore(); if(laserTrail.length) requestAnimationFrame(render); }

// ====== éµç›¤ ======
window.addEventListener('keydown',e=>{
  if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); if(history.length){redoStack.push(history.pop()); render();} }
  else if(e.ctrlKey && e.key.toLowerCase()==='y'){ e.preventDefault(); if(redoStack.length){history.push(redoStack.pop()); render();} }
  else if(e.key.toLowerCase()==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen?.(); else document.exitFullscreen?.(); }
  else if(e.key.toLowerCase()==='s'){ setActiveTool('select'); }
  else if(e.key.toLowerCase()==='p'){ setActiveTool('pen'); }
  else if(e.key.toLowerCase()==='h'){ setActiveTool('highlighter'); }
  else if(e.key.toLowerCase()==='e'){ setActiveTool('eraser'); }
  else if(e.key.toLowerCase()==='l'){ setActiveTool('line'); }
  else if(e.key.toLowerCase()==='r'){ setActiveTool('rect'); }
  else if(e.key.toLowerCase()==='t'){ setActiveTool('text'); }
  else if(e.key.toLowerCase()==='z'){ setActiveTool('laser'); }
  // è¤‡è£½ï¼šCtrl+Dï¼ˆç¾¤çµ„è¤‡è£½ï¼‰
  if(e.ctrlKey && (e.key.toLowerCase()==='d')){ e.preventDefault(); if(selection.length){ const off=20; const newIdx=[]; for(const i of selection){ const o=objects[i]; const copy=JSON.parse(JSON.stringify(o)); copy.x+=off; copy.y+=off; objects.push(copy); newIdx.push(objects.length-1); } selection=newIdx; render(); } }
  // åˆªé™¤
  if((e.key==='Delete'||e.key==='Backspace') && selection.length){ for(const i of selection.sort((a,b)=>b-a)){ objects.splice(i,1); } selection=[]; render(); }
});

// ====== ç¤ºæ„ï¼šé è¨­æ”¾å…©å€‹ç‰©ä»¶ä¾›æ¸¬è©¦ ======
objects.push({type:'textblock',text:'æ‹–æ›³ç©ºç™½å¯æ¡†é¸ï¼›Shift å¤šé¸ï¼›Ctrl+D è¤‡è£½',x:360,y:220,w:520,h:120,rot:0,color:'#e5e7eb',size:28});
objects.push({type:'textblock',text:'ç§»å‹•æ™‚å¸é™„æ ¼ç·š/ç‰©ä»¶ï¼Œé¡¯ç¤ºç´…è‰²å°å¼•ç·šï¼›æŠŠæ‰‹ç¸®æ”¾ã€ä¸Šæ–¹åœ“é»æ—‹è½‰ï¼›ğŸ”’ ç­‰æ¯”åˆ‡æ›æˆ–æŒ‰ä½ Alt éç­‰æ¯”ã€‚',x:420,y:360,w:640,h:140,rot:0,color:'#e5e7eb',size:24});
render();
</script>
</body>
</html>

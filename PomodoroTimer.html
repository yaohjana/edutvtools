<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課堂番茄鍾</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 50px;
        }

        /* 計時字體尺寸 */
        #timer-display {
            font-size: clamp(6rem, 25vw, 18rem);
            line-height: 1;
            font-weight: 700;
            user-select: none;
        }

        /* 強制深色 */
        .dark { background-color: #1f2937; color: #f3f4f6; }

        /* 隱藏數字輸入箭頭 */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 觸控友善按鈕 */
        .btn {
            padding: 1.25rem 2rem;
            font-size: 1.125rem;
            font-weight: 700;
            border-radius: 1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* 圖示按鈕 */
        .icon-btn {
            padding: 1rem;
            border-radius: 9999px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            background-color: #374151;
            color: #d1d5db;
        }
        .icon-btn:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.15); transform: scale(1.05); }
        .icon-btn.active { background-color: #4f46e5; color: #fff; box-shadow: 0 4px 10px rgba(79,70,229,.5); }

        .sidebar-content-bg { background-color: #374151; opacity: .95; transition: all .3s; }

        @media (min-width: 1024px) {
            .slide-wrapper {
                height: 100vh; width: 320px; padding-top: 2rem;
                transition: transform .4s cubic-bezier(.25,.46,.45,.94);
                transform: translateX(calc(100% - 50px));
            }
            .slide-wrapper:hover { transform: translateX(0); }
            .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; }
        }

        /* 預設時間按鈕色系 */
        .preset-btn-short { background-color:#20b2aa; color:#fff; box-shadow:0 4px 6px -1px rgba(32,178,170,.3); }
        .preset-btn-short:hover { background-color:#26a59d; transform: translateY(-2px); }
        .preset-btn-medium { background-color:#06b6d4; color:#fff; box-shadow:0 4px 6px -1px rgba(6,182,212,.3); }
        .preset-btn-medium:hover { background-color:#0e96b3; transform: translateY(-2px); }
        .preset-btn-long { background-color:#4f46e5; color:#fff; box-shadow:0 4px 6px -1px rgba(79,70,229,.3); }
        .preset-btn-long:hover { background-color:#4338ca; transform: translateY(-2px); }

        /* Timer 跳一下動畫 */
        @keyframes jump {
            0% { transform: translateY(0) scale(1); }
            35% { transform: translateY(-6px) scale(1.02); }
            70% { transform: translateY(0) scale(1); }
            100% { transform: translateY(0) scale(1); }
        }
        .jump-once { animation: jump 260ms ease; }

        /* 小型提示 (toast) 動畫 */
        @keyframes toastFade {
            0%   { opacity: 0; transform: translateY(6px); }
            10%  { opacity: 1; transform: translateY(0); }
            90%  { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-6px); }
        }
        .toast {
            animation: toastFade 1300ms ease forwards;
            background-color: rgba(17,24,39,.9);
            color:#fff;
            border-radius:.75rem;
            padding:.5rem .75rem;
            font-size:.95rem;
            pointer-events:none;
            box-shadow:0 6px 16px rgba(0,0,0,.25);
        }
    </style>
</head>
<body class="dark min-h-screen flex flex-col items-center p-4 sm:p-8">

    <!-- 右上角角落：全螢幕 + 實時時間 -->
    <div class="absolute top-4 right-4 flex items-center gap-2 z-50">
        <button id="fullscreen-toggle-btn" class="icon-btn p-3 bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-full" title="全螢幕切換 (F)">
            <svg id="fullscreen-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path>
            </svg>
        </button>
        <div id="current-time" class="text-xl sm:text-2xl font-semibold bg-gray-800 bg-opacity-50 backdrop-blur-sm p-3 rounded-xl shadow-md"></div>
    </div>
    
    <div id="app-container" class="flex flex-col w-full max-w-7xl mx-auto lg:gap-8 justify-center items-start">

        <div id="main-area" class="flex flex-col items-center w-full lg:w-full lg:px-20 order-2">
            <header class="text-center mb-8 w-full">
                <h1 class="text-4xl sm:text-5xl font-bold">課堂番茄鍾</h1>
            </header>

            <!-- 聲音設定圖示 -->
            <div class="flex justify-center gap-6 mb-10 w-full max-w-lg">
                <button id="icon-toggle-ticking" class="icon-btn" title="滴答聲開關">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button id="icon-toggle-alarm" class="icon-btn" title="提醒聲開關">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-2.809A4.004 4.004 0 0017 12V6a4 4 0 00-4-4H9a4 4 0 00-4 4v6a4.004 4.004 0 002.405 3.191L7 17h5m-2 4h4"></path></svg>
                </button>
                <button id="icon-toggle-speech" class="icon-btn" title="語音播報開關">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7v-2a5 5 0 005-5h2zM12 18V2a3 3 0 003 3v2a3 3 0 00-3-3v14a3 3 0 003-3v-2a3 3 0 00-3 3zM4 11a7 7 0 017 7v-2a5 5 0 00-5-5H4z"></path></svg>
                </button>
            </div>
            
            <!-- 計時器顯示 -->
            <div class="relative w-full max-w-4xl flex flex-col items-center">
                <div id="timer-display" class="mb-6 p-4 rounded-3xl shadow-2xl transition duration-500 ease-in-out dark:bg-gray-700 w-full text-center">
                    <span id="timer-text">25:00</span>
                </div>
                <!-- 動態小提示容器 -->
                <div id="toast-area" class="absolute -bottom-2 translate-y-full"></div>
            </div>

            <!-- 控制按鈕：開始/暫停（合併）、重設、延長一分鐘 -->
            <div class="flex flex-wrap justify-center gap-4 mb-10 w-full max-w-4xl">
                <button id="toggle-btn" class="btn bg-indigo-600 text-white hover:bg-indigo-700 flex-grow sm:flex-grow-0" title="開始/暫停 (Space)">
                    開始
                </button>
                <button id="reset-btn" class="btn bg-gray-500 text-white hover:bg-gray-600 flex-grow sm:flex-grow-0" title="重設 (R)">
                    重設
                </button>
                <button id="add-minute-btn" class="btn bg-pink-600 text-white hover:bg-pink-700 flex-grow sm:flex-grow-0" title="延長一分鐘 (A)">
                    延長一分鐘
                </button>
            </div>
        </div>
        
        <!-- 手機/平板 設定（略，與原本相同） -->
        <div id="sidebar-area-mobile" class="w-full pt-8 order-1 lg:hidden">
            <div class="sidebar-content-bg p-6 rounded-2xl shadow-2xl flex flex-col gap-8 w-full">
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-center">自訂分鐘數</h2>
                    <div class="flex flex-col gap-4 items-center">
                        <input type="number" id="custom-minutes-input-mobile" min="1" max="999" value="25" 
                               class="w-full p-4 text-3xl text-center rounded-xl border-2 border-indigo-500 dark:bg-gray-700 dark:text-white transition duration-200 focus:border-indigo-600 font-mono">
                        <button id="set-custom-time-btn-mobile" class="btn bg-pink-600 text-white hover:bg-pink-700 w-full p-3 text-lg">確定並設定</button>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-center border-t pt-4 border-gray-700 lg:border-none lg:pt-0">預設時間 (分鐘)</h2>
                    <div class="grid grid-cols-3 gap-3 sm:grid-cols-4">
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="1">1</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="2">2</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="3">3</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="5">5</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="10">10</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="15">15</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="20">20</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="25">25</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="30">30</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="40">40</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="45">45</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 桌面滑動設定（保留原樣） -->
    <div id="sidebar-area-desktop" class="hidden lg:block fixed top-0 right-0 h-full z-40">
        <div class="slide-wrapper relative">
            <div class="absolute top-1/3 left-0 transform -translate-x-full -translate-y-1/2 bg-indigo-600 text-white p-3 rounded-l-lg shadow-xl cursor-pointer vertical-text font-bold text-lg hover:bg-indigo-700">設定</div>
            <div class="h-full w-full sidebar-content-bg p-6 rounded-l-2xl shadow-2xl flex flex-col gap-8 overflow-y-auto" style="padding-top: 6rem; padding-bottom: 50px;">
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-center">自訂分鐘數</h2>
                    <div class="flex flex-col gap-4 items-center">
                        <input type="number" id="custom-minutes-input-desktop" min="1" max="999" value="25" 
                               class="w-full p-4 text-3xl text-center rounded-xl border-2 border-indigo-500 dark:bg-gray-700 dark:text-white transition duration-200 focus:border-indigo-600 font-mono">
                        <button id="set-custom-time-btn-desktop" class="btn bg-pink-600 text-white hover:bg-pink-700 w-full p-3 text-lg">確定並設定</button>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-center border-t pt-4 border-gray-700">預設時間 (分鐘)</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="1">1</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="2">2</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="3">3</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="5">5</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="10">10</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="15">15</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="20">20</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="25">25</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="30">30</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="40">40</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="45">45</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 w-full bg-gray-800 bg-opacity-70 text-white text-right p-3 text-sm z-50 shadow-lg">
        Developed by DennisZ
    </footer>

    <!-- 隱藏狀態 -->
    <div class="hidden">
        <input type="checkbox" id="toggle-ticking" checked>
        <input type="checkbox" id="toggle-alarm" checked>
        <input type="checkbox" id="toggle-speech" checked>
    </div>

    <!-- 共用訊息框（保留） -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="dark:bg-gray-700 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <p id="message-text" class="text-xl font-semibold mb-6"></p>
            <button id="close-message-btn" class="btn bg-indigo-600 text-white hover:bg-indigo-700 w-full">確認</button>
        </div>
    </div>

    <script>
        // 節點
        const timerText = document.getElementById('timer-text');
        const toggleBtn = document.getElementById('toggle-btn');
        const resetBtn = document.getElementById('reset-btn');
        const addMinuteBtn = document.getElementById('add-minute-btn');
        const currentTimeDisplay = document.getElementById('current-time');
        const fullscreenToggleBtn = document.getElementById('fullscreen-toggle-btn');
        const fullscreenIcon = document.getElementById('fullscreen-icon');
        const toastArea = document.getElementById('toast-area');

        // 隱藏設定
        const toggleTicking = document.getElementById('toggle-ticking');
        const toggleAlarm = document.getElementById('toggle-alarm');
        const toggleSpeech = document.getElementById('toggle-speech');
        const iconToggleTicking = document.getElementById('icon-toggle-ticking');
        const iconToggleAlarm = document.getElementById('icon-toggle-alarm');
        const iconToggleSpeech = document.getElementById('icon-toggle-speech');

        // 手機/桌面輸入
        let customMinutesInput, setCustomTimeBtn;
        const presetBtns = document.querySelectorAll('.preset-btn');

        // 狀態
        let totalSeconds = 25 * 60;
        let secondsLeft = totalSeconds;
        let isRunning = false;
        let timerInterval;
        let audioContext;
        let isTicking = false;

        /* 初始化輸入來源切換 */
        function setupSidebarInputs() {
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop) {
                customMinutesInput = document.getElementById('custom-minutes-input-desktop');
                setCustomTimeBtn = document.getElementById('set-custom-time-btn-desktop');
            } else {
                customMinutesInput = document.getElementById('custom-minutes-input-mobile');
                setCustomTimeBtn = document.getElementById('set-custom-time-btn-mobile');
            }
            if (setCustomTimeBtn) {
                setCustomTimeBtn.removeEventListener('click', setCustomTime);
                setCustomTimeBtn.addEventListener('click', setCustomTime);
            }
        }
        window.addEventListener('resize', setupSidebarInputs);

        /* 小提示 */
        function showToast(text) {
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = text;
            toastArea.appendChild(el);
            setTimeout(() => el.remove(), 1300);
        }

        /* 訊息框（保留） */
        function showMessageBox(message) {
            document.getElementById('message-text').textContent = message;
            const box = document.getElementById('message-box');
            box.classList.remove('hidden'); box.classList.add('flex');
            document.getElementById('close-message-btn').onclick = () => {
                box.classList.add('hidden'); box.classList.remove('flex');
            };
        }

        /* Audio */
        function initAudioContext() {
            if (!audioContext) {
                try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
                catch (e) { console.error('Web Audio API 不可用:', e); showMessageBox('瀏覽器不支持 Web Audio API'); }
            }
        }
        function playTick() {
            if (!toggleTicking.checked || isTicking) return;
            initAudioContext(); if (!audioContext) return;
            isTicking = true;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(440, audioContext.currentTime);
            gain.gain.setValueAtTime(0.05, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.05);
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.start(); osc.stop(audioContext.currentTime + 0.05);
            setTimeout(()=>{ isTicking = false; }, 100);
        }
        function playAlarmSound() {
            if (!toggleAlarm.checked) return;
            initAudioContext(); if (!audioContext) return;
            const dur = 1.0, t0 = audioContext.currentTime;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(660, t0);
            gain.gain.setValueAtTime(0, t0);
            gain.gain.linearRampToValueAtTime(0.3, t0 + 0.1);
            gain.gain.linearRampToValueAtTime(0.0001, t0 + dur);
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.start(t0); osc.stop(t0 + dur + 0.1);
        }
        function speakAlert() {
            if (!toggleSpeech.checked || !window.speechSynthesis) return;
            const u = new SpeechSynthesisUtterance("時間到！請休息一下，或者開始下一個活動吧。");
            const voices = window.speechSynthesis.getVoices();
            const zh = voices.find(v => v.lang === 'zh-TW' || v.lang === 'zh-CN');
            if (zh) u.voice = zh; u.lang='zh-TW'; u.rate=1; u.pitch=1;
            window.speechSynthesis.speak(u);
        }
        if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = () => {};

        /* UI 狀態 */
        function updateButtonStates() {
            toggleBtn.textContent = isRunning ? '暫停' : (secondsLeft>0 && secondsLeft<totalSeconds ? '繼續' : '開始');
            toggleBtn.disabled = (secondsLeft === 0 && !isRunning);
            resetBtn.disabled = (secondsLeft === totalSeconds && !isRunning);
        }

        function updateTimerDisplay() {
            const m = Math.floor(secondsLeft / 60);
            const s = secondsLeft % 60;
            timerText.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function updateCurrentTime() {
            const now = new Date();
            currentTimeDisplay.textContent = now.toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
        }

        /* 計時邏輯 */
        function countdown() {
            secondsLeft--;
            if (toggleTicking.checked) playTick();
            if (secondsLeft < 0) {
                clearInterval(timerInterval); isRunning = false; secondsLeft = 0;
                updateTimerDisplay(); playAlarmSound(); speakAlert(); showMessageBox("倒數計時結束！");
                updateButtonStates(); return;
            }
            updateTimerDisplay();
        }

        function startTimer() {
            if (secondsLeft <= 0) { showMessageBox("請先設定一個有效時間！"); return; }
            initAudioContext();
            clearInterval(timerInterval);
            timerInterval = setInterval(countdown, 1000);
            isRunning = true;
            updateButtonStates();
        }

        function pauseTimer() {
            if (!isRunning) return;
            clearInterval(timerInterval);
            isRunning = false;
            updateButtonStates();
        }

        function toggleStartPause() {
            if (isRunning) pauseTimer(); else startTimer();
        }

        function resetTimer(minutes) {
            clearInterval(timerInterval);
            isRunning = false;
            if (minutes !== undefined) {
                totalSeconds = minutes * 60;
                const mIn = document.getElementById('custom-minutes-input-mobile');
                const dIn = document.getElementById('custom-minutes-input-desktop');
                if (mIn) mIn.value = minutes;
                if (dIn) dIn.value = minutes;
            }
            secondsLeft = totalSeconds;
            updateTimerDisplay();
            updateButtonStates();
        }

        function setCustomTime() {
            if (!customMinutesInput) return;
            const minutes = parseInt(customMinutesInput.value);
            if (isNaN(minutes) || minutes <= 0 || minutes > 999) {
                showMessageBox("請輸入 1~999 的有效分鐘數！");
                customMinutesInput.value = Math.floor(totalSeconds / 60);
                return;
            }
            const otherId = customMinutesInput.id === 'custom-minutes-input-mobile' ? 'custom-minutes-input-desktop' : 'custom-minutes-input-mobile';
            const other = document.getElementById(otherId);
            if (other) other.value = minutes;
            resetTimer(minutes);
            showToast(`已設定 ${minutes} 分鐘`);
        }

        /* 延長一分鐘：數字跳一下 + 小提示 */
        function addOneMinute() {
            secondsLeft += 60;
            // 若希望 reset 後總時長也增加，同步打開下一行：
            // totalSeconds += 60;
            timerText.classList.remove('jump-once'); void timerText.offsetWidth; // 重新觸發動畫
            timerText.classList.add('jump-once');
            updateTimerDisplay();
            updateButtonStates();
            showToast('已延長 1 分鐘');
        }

        /* 設定儲存 & 圖示樣式 */
        function saveSettings() {
            localStorage.setItem('toggle-ticking', toggleTicking.checked);
            localStorage.setItem('toggle-alarm', toggleAlarm.checked);
            localStorage.setItem('toggle-speech', toggleSpeech.checked);
        }
        function updateIconStyle(el, checked){ el.classList.toggle('active', !!checked); }
        function loadSettings() {
            const load = (id, def, iconEl) => {
                const v = localStorage.getItem(id);
                const el = document.getElementById(id);
                if (!el) return;
                const checked = v === null ? def : (v === 'true');
                el.checked = checked; updateIconStyle(iconEl, checked);
            };
            load('toggle-ticking', true, iconToggleTicking);
            load('toggle-alarm', true, iconToggleAlarm);
            load('toggle-speech', true, iconToggleSpeech);
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
        }
        function handleIconToggle(btn, chk) { chk.checked = !chk.checked; updateIconStyle(btn, chk.checked); saveSettings(); }

        /* 全螢幕 */
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => { showMessageBox(`無法開啟全螢幕：${err.message}`); });
            } else { document.exitFullscreen(); }
        }
        function handleFullscreenChange() {
            if (document.fullscreenElement) {
                fullscreenIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 10h4m0 0v4m0-4l-4 4m-4 4H6m0 0v-4m0 4l4-4m4-4V6m0 0H6m0 0l4 4m4-4h4m0 0v4m0-4l-4 4"></path>`;
            } else {
                fullscreenIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path>`;
            }
        }

        /* 鍵盤快捷鍵 */
        function handleHotkeys(e) {
            const tag = document.activeElement?.tagName?.toLowerCase();
            const isTyping = tag === 'input' || tag === 'textarea';
            if (isTyping) return;

            if (e.code === 'Space') { e.preventDefault(); toggleStartPause(); }        // Space：開始/暫停
            else if (e.key === 'f' || e.key === 'F') { e.preventDefault(); toggleFullscreen(); } // F：全螢幕
            else if (e.key === 'r' || e.key === 'R') { e.preventDefault(); resetTimer(); }       // R：重設
            else if (e.key === 'a' || e.key === 'A') { e.preventDefault(); addOneMinute(); }     // A：延長一分鐘
        }

        /* 初始化 */
        window.onload = function () {
            loadSettings();
            resetTimer(25);
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            setupSidebarInputs();

            toggleBtn.addEventListener('click', toggleStartPause);
            resetBtn.addEventListener('click', () => resetTimer());
            addMinuteBtn.addEventListener('click', addOneMinute);

            iconToggleTicking.addEventListener('click', () => handleIconToggle(iconToggleTicking, toggleTicking));
            iconToggleAlarm.addEventListener('click', () => handleIconToggle(iconToggleAlarm, toggleAlarm));
            iconToggleSpeech.addEventListener('click', () => handleIconToggle(iconToggleSpeech, toggleSpeech));

            if (fullscreenToggleBtn) {
                fullscreenToggleBtn.addEventListener('click', toggleFullscreen);
                document.addEventListener('fullscreenchange', handleFullscreenChange);
                document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
                document.addEventListener('mozfullscreenchange', handleFullscreenChange);
                document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            }

            presetBtns.forEach(btn => {
                btn.addEventListener('click', function(){
                    const minutes = parseInt(this.getAttribute('data-minutes'));
                    resetTimer(minutes);
                    startTimer();
                });
            });

            document.addEventListener('keydown', handleHotkeys);
            document.addEventListener('click', initAudioContext, { once: true });

            updateButtonStates();
        };
    </script>
</body>
</html>

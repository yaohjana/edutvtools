<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課堂番茄鍾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            /* 預留頁底空間，避免被固定版權遮住 */
            padding-bottom: 50px; 
        }

        /* 確保時間顯示字體極大，方便全班看 */
        #timer-display {
            font-size: clamp(6rem, 25vw, 18rem); /* 響應式字體，小螢幕 6rem，大螢幕 18rem */
            line-height: 1;
            font-weight: 700;
            user-select: none;
        }

        /* 強制深色模式設定 */
        .dark {
            background-color: #1f2937; /* 深灰背景 */
            color: #f3f4f6; /* 淺色文字 */
        }
        
        /* 隱藏數字輸入框的上下箭頭（Chrome, Safari, Edge, Opera, Firefox） */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* 專為觸控設計的大按鈕樣式 */
        .btn {
            padding: 1.5rem 2.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-radius: 1.5rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* 圖示按鈕基礎樣式 */
        .icon-btn {
            padding: 1rem;
            border-radius: 9999px; /* 圓形 */
            transition: all 0.2s;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            background-color: #374151;
            color: #d1d5db;
        }

        .icon-btn:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
            transform: scale(1.05);
        }
        
        /* 圖示按鈕啟動狀態 (亮起來) */
        .icon-btn.active {
            background-color: #4f46e5; /* Indigo */
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.5); /* 帶有藍色光暈 */
        }
        
        /* --- 側邊欄設定 (半隱藏視覺效果) --- */
        .sidebar-content-bg {
            background-color: #374151;
            opacity: 0.95; /* 輕微透明 */
            transition: all 0.3s;
        }

        /* 桌面滑動選單 (lg 螢幕以上才套用) */
        @media (min-width: 1024px) {
            .slide-wrapper {
                height: 100vh;
                width: 320px; /* 決定滑動距離 */
                padding-top: 2rem;
                transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                
                /* 初始位置: 往左移，只露出 50px 書籤標籤 */
                transform: translateX(calc(100% - 50px)); 
            }

            .slide-wrapper:hover {
                transform: translateX(0); /* 滑鼠移入時完全顯示 */
            }
            
            /* 讓書籤文字垂直顯示 */
            .vertical-text {
                writing-mode: vertical-rl;
                text-orientation: mixed;
            }
        }

        /* --- 預設時間按鈕顏色區分 (更名為直觀的長度) --- */
        
        /* 1~5 分鐘 (超短/休息) */
        .preset-btn-short { 
            background-color: #20b2aa; 
            color: white;
            box-shadow: 0 4px 6px -1px rgba(32, 178, 170, 0.3);
        }
        .preset-btn-short:hover { 
            background-color: #26a59d; 
            transform: translateY(-2px);
        }

        /* 10~25 分鐘 (中等/標準番茄) */
        .preset-btn-medium { 
            background-color: #06b6d4; /* Cyan 500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.3);
        }
        .preset-btn-medium:hover { 
            background-color: #0e96b3; 
            transform: translateY(-2px);
        }

        /* 30~45 分鐘 (長時間/一堂課) */
        .preset-btn-long { 
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        .preset-btn-long:hover { 
            background-color: #4338ca; 
            transform: translateY(-2px);
        }

    </style>
</head>
<body class="dark min-h-screen flex flex-col items-center p-4 sm:p-8">

    <div class="absolute top-4 right-4 flex items-center gap-2 z-50">
	
		<button id="fullscreen-toggle-btn" class="icon-btn p-3 bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-full" title="全螢幕切換">
            <svg id="fullscreen-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path>
            </svg>
        </button>
		
        <div id="current-time" class="text-xl sm:text-2xl font-semibold bg-gray-800 bg-opacity-50 backdrop-blur-sm p-3 rounded-xl shadow-md">
            </div>
        
    </div>
    
    <div id="app-container" class="flex flex-col w-full max-w-7xl mx-auto lg:gap-8 justify-center items-start">

        <div id="main-area" class="flex flex-col items-center w-full lg:w-full lg:px-20 order-2">
            <header class="text-center mb-8 w-full">
                <h1 class="text-4xl sm:text-5xl font-bold">課堂番茄鍾</h1>
            </header>

            <div class="flex justify-center gap-6 mb-10 w-full max-w-lg">
                <button id="icon-toggle-ticking" class="icon-btn" data-setting-id="toggle-ticking" title="滴答聲開關">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                <button id="icon-toggle-alarm" class="icon-btn" data-setting-id="toggle-alarm" title="提醒聲開關">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-2.809A4.004 4.004 0 0017 12V6a4 4 0 00-4-4H9a4 4 0 00-4 4v6a4.004 4.004 0 002.405 3.191L7 17h5m-2 4h4"></path>
                    </svg>
                </button>
                <button id="icon-toggle-speech" class="icon-btn" data-setting-id="toggle-speech" title="語音播報開關">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7v-2a5 5 0 005-5h2zM12 18V2a3 3 0 003 3v2a3 3 0 00-3-3v14a3 3 0 003-3v-2a3 3 0 00-3 3zM4 11a7 7 0 017 7v-2a5 5 0 00-5-5H4z"></path>
                    </svg>
                </button>
            </div>
            
            <div id="timer-display" class="relative mb-10 p-4 rounded-3xl shadow-2xl transition duration-500 ease-in-out dark:bg-gray-700 w-full max-w-4xl text-center">
                <button id="add-minute-btn"
                        class="absolute top-3 right-3 w-12 h-12 rounded-full bg-pink-600 hover:bg-pink-700 text-white font-bold shadow-lg 
                               focus:outline-none focus:ring-2 focus:ring-pink-400 focus:ring-offset-2 focus:ring-offset-gray-700"
                        title="本次倒數加 1 分鐘">
                    +1
                </button>
                <span id="timer-text">25:00</span>
            </div>

            <div class="flex flex-wrap justify-center gap-4 mb-10 w-full max-w-4xl">
                <button id="start-btn" class="btn bg-indigo-600 text-white hover:bg-indigo-700 flex-grow sm:flex-grow-0">
                    開始
                </button>
                <button id="pause-btn" class="btn bg-yellow-500 text-white hover:bg-yellow-600 flex-grow sm:flex-grow-0" disabled>
                    暫停
                </button>
                <button id="reset-btn" class="btn bg-gray-500 text-white hover:bg-gray-600 flex-grow sm:flex-grow-0">
                    重設
                </button>
            </div>
        </div>
        
        <div id="sidebar-area-mobile" class="w-full pt-8 order-1 lg:hidden">
            <div id="sidebar-container-mobile" class="sidebar-content-bg p-6 rounded-2xl shadow-2xl flex flex-col gap-8 w-full">
                
                <div id="custom-minutes-section-mobile">
                    <h2 class="text-xl font-semibold mb-4 text-center">自訂分鐘數</h2>
                    <div class="flex flex-col gap-4 items-center">
                        <input type="number" id="custom-minutes-input-mobile" min="1" max="999" value="25" 
                               class="w-full p-4 text-3xl text-center rounded-xl border-2 border-indigo-500 dark:bg-gray-700 dark:text-white transition duration-200 focus:border-indigo-600 font-mono">
                        
                        <button id="set-custom-time-btn-mobile" class="btn bg-pink-600 text-white hover:bg-pink-700 w-full p-3 text-lg">
                            確定並設定
                        </button>
                    </div>
                </div>

                <div id="preset-times-section-mobile">
                    <h2 class="text-xl font-semibold mb-4 text-center border-t pt-4 border-gray-700 lg:border-none lg:pt-0">預設時間 (分鐘)</h2>
                    <div class="grid grid-cols-3 gap-3 sm:grid-cols-4">
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="1">1</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="2">2</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="3">3</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="5">5</button>
                        
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="10">10</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="15">15</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="20">20</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="25">25</button>
                        
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="30">30</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="40">40</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="45">45</button>
                    </div>
                </div>

            </div>
        </div> </div> <div id="sidebar-area-desktop" class="hidden lg:block fixed top-0 right-0 h-full z-40">
        <div id="slide-wrapper" class="slide-wrapper relative">
            
            <div id="bookmark-tab" 
                 class="absolute top-1/3 left-0 transform -translate-x-full -translate-y-1/2 
                        bg-indigo-600 text-white p-3 rounded-l-lg shadow-xl cursor-pointer 
                        vertical-text font-bold text-lg hover:bg-indigo-700">
                設定
            </div>
            
            <div id="sidebar-container-desktop" 
                 class="h-full w-full sidebar-content-bg p-6 rounded-l-2xl shadow-2xl flex flex-col gap-8 overflow-y-auto" 
                 style="padding-top: 6rem; padding-bottom: 50px;">
                
                <div id="custom-minutes-section-desktop">
                    <h2 class="text-xl font-semibold mb-4 text-center">自訂分鐘數</h2>
                    <div class="flex flex-col gap-4 items-center">
                        <input type="number" id="custom-minutes-input-desktop" min="1" max="999" value="25" 
                               class="w-full p-4 text-3xl text-center rounded-xl border-2 border-indigo-500 dark:bg-gray-700 dark:text-white transition duration-200 focus:border-indigo-600 font-mono">
                        
                        <button id="set-custom-time-btn-desktop" class="btn bg-pink-600 text-white hover:bg-pink-700 w-full p-3 text-lg">
                            確定並設定
                        </button>
                    </div>
                </div>

                <div id="preset-times-section-desktop">
                    <h2 class="text-xl font-semibold mb-4 text-center border-t pt-4 border-gray-700">預設時間 (分鐘)</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="1">1</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="2">2</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="3">3</button>
                        <button class="preset-btn btn preset-btn-short p-3" data-minutes="5">5</button>
                        
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="10">10</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="15">15</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="20">20</button>
                        <button class="preset-btn btn preset-btn-medium p-3" data-minutes="25">25</button>
                        
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="30">30</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="40">40</button>
                        <button class="preset-btn btn preset-btn-long p-3" data-minutes="45">45</button>
                    </div>
                </div>

            </div>
        </div>
    </div> <footer class="fixed bottom-0 left-0 w-full bg-gray-800 bg-opacity-70 text-white text-right p-3 text-sm z-50 shadow-lg">
        Developed by DennisZ
    </footer>

    <div class="hidden">
        <input type="checkbox" id="toggle-ticking" checked>
        <input type="checkbox" id="toggle-alarm" checked>
        <input type="checkbox" id="toggle-speech" checked>
    </div>

    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="dark:bg-gray-700 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <p id="message-text" class="text-xl font-semibold mb-6"></p>
            <button id="close-message-btn" class="btn bg-indigo-600 text-white hover:bg-indigo-700 w-full">瞭解了</button>
        </div>
    </div>

    <script>
        // 全域變數
        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');

        const currentTimeDisplay = document.getElementById('current-time');
        const fullscreenToggleBtn = document.getElementById('fullscreen-toggle-btn');
        const fullscreenIcon = document.getElementById('fullscreen-icon');

        // 時間文字與 +1 按鈕節點
        const timerText = document.getElementById('timer-text');
        const addMinuteBtn = document.getElementById('add-minute-btn');
        
        // 隱藏的狀態儲存 checkbox
        const toggleTicking = document.getElementById('toggle-ticking');
        const toggleAlarm = document.getElementById('toggle-alarm');
        const toggleSpeech = document.getElementById('toggle-speech');
        
        // 圖示按鈕
        const iconToggleTicking = document.getElementById('icon-toggle-ticking');
        const iconToggleAlarm = document.getElementById('icon-toggle-alarm');
        const iconToggleSpeech = document.getElementById('icon-toggle-speech');

        // 自訂時間輸入框與按鈕 (需動態決定手機或桌面版本)
        let customMinutesInput;
        let setCustomTimeBtn;
        
        // 預設時間按鈕集合
        const presetBtns = document.querySelectorAll('.preset-btn');
        
        let totalSeconds = 25 * 60; // 預設 25 分鐘
        let secondsLeft = totalSeconds;
        let isRunning = false;
        let timerInterval;
        let audioContext;
        let isTicking = false;
        
        // 偵測螢幕大小以選擇正確的輸入元素
        function setupSidebarInputs() {
            const isDesktop = window.innerWidth >= 1024; // Tailwind lg breakpoint
            
            // 由於輸入框 ID 不同，需要根據螢幕大小綁定正確的元素
            if (isDesktop) {
                customMinutesInput = document.getElementById('custom-minutes-input-desktop');
                setCustomTimeBtn = document.getElementById('set-custom-time-btn-desktop');
            } else {
                customMinutesInput = document.getElementById('custom-minutes-input-mobile');
                setCustomTimeBtn = document.getElementById('set-custom-time-btn-mobile');
            }
            
            // 每次切換後，重新綁定事件，避免重複或無效綁定
            if (setCustomTimeBtn) {
                setCustomTimeBtn.removeEventListener('click', setCustomTime);
                setCustomTimeBtn.addEventListener('click', setCustomTime);
            }
        }
        
        // 監聽窗口大小變化，動態切換輸入元素
        window.addEventListener('resize', setupSidebarInputs);


        // --- 輔助功能 ---

        /**
         * 顯示自定義訊息框（讓使用者知道發生什麼事）
         * @param {string} message 要顯示的訊息
         */
        function showMessageBox(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
            document.getElementById('close-message-btn').onclick = () => {
                document.getElementById('message-box').classList.add('hidden');
                document.getElementById('message-box').classList.remove('flex');
            };
        }
        
        // --- 聲音和語音功能 ---

        /**
         * 初始化 Web Audio Context
         */
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error('Web Audio API 無法使用:', e);
                    showMessageBox('你的瀏覽器不支持 Web Audio API，滴答聲和提醒聲會沒聲音喔！');
                }
            }
        }

        /**
         * 播放滴答聲 (Web Audio API)
         */
        function playTick() {
            // 如果沒開滴答聲或正在播放，就跳過
            if (!audioContext || !toggleTicking.checked || isTicking) return;
            initAudioContext();
            isTicking = true;
            const tickLength = 0.05;
            const frequency = 440;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + tickLength);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + tickLength);

            // 確保聲音不會重疊
            setTimeout(() => {
                isTicking = false;
            }, tickLength * 1000 + 50);
        }

        /**
         * 播放時間到提醒聲 (Web Audio API)
         */
        function playAlarmSound() {
            if (!audioContext || !toggleAlarm.checked) return;
            initAudioContext();
            
            const duration = 1.0;
            const frequency = 660;
            const currentTime = audioContext.currentTime;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, currentTime);
            gainNode.gain.setValueAtTime(0, currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, currentTime + 0.1);
            gainNode.gain.linearRampToValueAtTime(0.0001, currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start(currentTime);
            oscillator.stop(currentTime + duration + 0.1);
        }

        /**
         * 語音播報 (Web Speech API)
         */
        function speakAlert() {
            if (!toggleSpeech.checked || !window.speechSynthesis) return;

            const message = "時間到囉！請休息一下，或者開始下一個活動吧。";
            const utterance = new SpeechSynthesisUtterance(message);
            
            const voices = window.speechSynthesis.getVoices();
            // 優先找台灣或中文語音
            const chineseVoice = voices.find(voice => voice.lang === 'zh-TW' || voice.lang === 'zh-CN');
            if (chineseVoice) {
                utterance.voice = chineseVoice;
            }
            
            utterance.lang = 'zh-TW';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            
            window.speechSynthesis.speak(utterance);
        }
        
        // 確保語音能正確載入
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                // 語音載入完成
            };
        }


        // --- 計時器核心邏輯 ---

        /**
         * 更新按鈕啟用/禁用狀態
         */
        function updateButtonStates() {
            if (isRunning) {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                resetBtn.disabled = false;
                startBtn.textContent = '進行中...';
            } else {
                if (secondsLeft > 0 && secondsLeft < totalSeconds) {
                    startBtn.textContent = '繼續';
                    startBtn.disabled = false;
                } else {
                    startBtn.textContent = '開始';
                    startBtn.disabled = secondsLeft === 0;
                }
                
                pauseBtn.disabled = true;
                resetBtn.disabled = secondsLeft === totalSeconds; // 只有在時間被更動後才允許重設
            }
        }


        /**
         * 更新時間顯示
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            if (timerText) {
                timerText.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        /**
         * 更新右上角實時時間
         */
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', // 精確到秒
                hour12: false 
            });
            currentTimeDisplay.textContent = timeString;
        }

        /**
         * 主要倒數計時函數（每秒觸發）
         */
        function countdown() {
            secondsLeft--;

            if (toggleTicking.checked) {
                playTick();
            }

            if (secondsLeft < 0) {
                clearInterval(timerInterval);
                isRunning = false;
                secondsLeft = 0;
                updateTimerDisplay();

                playAlarmSound();
                speakAlert();
                showMessageBox("時間到！下課休息囉！");
                updateButtonStates();
                return;
            }
            
            updateTimerDisplay();
        }

        /**
         * 啟動計時器
         */
        function startTimer() {
            if (secondsLeft <= 0) {
                showMessageBox("請先設定一個有效時間，才能開始倒數喔！");
                return;
            }
            
            initAudioContext();
            timerInterval = setInterval(countdown, 1000);
            isRunning = true;
            updateButtonStates();
        }

        /**
         * 暫停計時器
         */
        function pauseTimer() {
            if (!isRunning) return;

            clearInterval(timerInterval);
            isRunning = false;
            updateButtonStates();
        }


        /**
         * 重設計時器
         * @param {number} minutes 新的分鐘數 (可選，如果沒有就用上次設定的總時間)
         */
        function resetTimer(minutes) {
            clearInterval(timerInterval);
            isRunning = false;

            if (minutes !== undefined) {
                totalSeconds = minutes * 60;
                
                // 同步更新手機和桌面的輸入框值
                if (document.getElementById('custom-minutes-input-mobile')) {
                     document.getElementById('custom-minutes-input-mobile').value = minutes;
                }
                if (document.getElementById('custom-minutes-input-desktop')) {
                     document.getElementById('custom-minutes-input-desktop').value = minutes;
                }
            }
            secondsLeft = totalSeconds;
            
            updateTimerDisplay();
            updateButtonStates();
        }

        /**
         * 處理自訂時間設定
         */
        function setCustomTime() {
            if (!customMinutesInput) return;

            const minutes = parseInt(customMinutesInput.value);
            if (isNaN(minutes) || minutes <= 0 || minutes > 999) {
                showMessageBox("只能輸入 1 到 999 之間的分鐘數啦！");
                // 恢復舊值到當前使用的輸入框
                customMinutesInput.value = Math.floor(totalSeconds / 60); 
                return;
            }
            
            // 由於兩個輸入框共用邏輯，需要同步更新另一個輸入框的值
            const otherInputId = customMinutesInput.id === 'custom-minutes-input-mobile' 
                ? 'custom-minutes-input-desktop' 
                : 'custom-minutes-input-mobile';
                
            const otherInput = document.getElementById(otherInputId);
            if (otherInput) {
                otherInput.value = minutes;
            }

            resetTimer(minutes);
            showMessageBox(`已經設定好 ${minutes} 分鐘囉，準備開始！`);
        }

        /**
         * 計時中途 +1 分鐘 (老師們的最愛)
         */
        function addOneMinute() {
            secondsLeft += 60;
            updateTimerDisplay();
            updateButtonStates();

            // 視覺回饋
            const btn = document.getElementById('add-minute-btn');
            if (btn) {
                btn.classList.add('scale-105');
                setTimeout(() => btn.classList.remove('scale-105'), 120);
            }
        }

        // --- 設定儲存與圖示樣式控制 ---

        /**
         * 儲存設定到瀏覽器
         */
        function saveSettings() {
            localStorage.setItem('toggle-ticking', toggleTicking.checked);
            localStorage.setItem('toggle-alarm', toggleAlarm.checked);
            localStorage.setItem('toggle-speech', toggleSpeech.checked);
        }

        /**
         * 更新圖示按鈕樣式 (點擊後亮/滅)
         */
        function updateIconStyle(iconElement, isChecked) {
            if (isChecked) {
                iconElement.classList.add('active');
            } else {
                iconElement.classList.remove('active');
            }
        }

        /**
         * 從儲存空間載入設定
         */
        function loadSettings() {
            // 載入開關狀態並更新圖示
            const loadToggle = (id, defaultValue, iconElement) => {
                const setting = localStorage.getItem(id);
                const element = document.getElementById(id);
                
                if (element) {
                    const isChecked = setting === null ? defaultValue : (setting === 'true');
                    element.checked = isChecked;
                    updateIconStyle(iconElement, isChecked);
                }
            };

            loadToggle('toggle-ticking', true, iconToggleTicking);
            loadToggle('toggle-alarm', true, iconToggleAlarm);
            loadToggle('toggle-speech', true, iconToggleSpeech);
            
            // 由於只有深色模式，不需要載入主題，但保留 class
            document.documentElement.classList.add('dark');
        }

        /**
         * 處理圖示按鈕點擊
         */
        function handleIconToggle(iconButton, hiddenCheckbox) {
            // 切換狀態
            hiddenCheckbox.checked = !hiddenCheckbox.checked;
            
            // 更新視覺樣式與儲存新狀態
            updateIconStyle(iconButton, hiddenCheckbox.checked);
            saveSettings();
        }

        // --- 全螢幕功能 ---

        /**
         * 切換全螢幕模式
         */
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // 進入全螢幕模式
                document.documentElement.requestFullscreen().catch(err => {
                    showMessageBox(`無法全螢幕，請確認瀏覽器設定：${err.message}`);
                });
            } else {
                // 退出全螢幕模式
                document.exitFullscreen();
            }
        }

        /**
         * 處理全螢幕狀態變化時，更新按鈕圖示
         */
        function handleFullscreenChange() {
            if (document.fullscreenElement) {
                // 目前是全螢幕：顯示退出全螢幕圖示
                fullscreenIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 10h4m0 0v4m0-4l-4 4m-4 4H6m0 0v-4m0 4l4-4m4-4V6m0 0H6m0 0l4 4m4-4h4m0 0v4m0-4l-4 4"></path>
                `;
            } else {
                // 不是全螢幕：顯示進入全螢幕圖示 (四角展開)
                fullscreenIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path>
                `;
            }
        }


        // --- 事件監聽器綁定 ---

        function attachEventListeners() {
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', () => resetTimer()); // 點擊重設鈕就使用上次設定的總時間
            addMinuteBtn.addEventListener('click', addOneMinute);
            fullscreenToggleBtn.addEventListener('click', toggleFullscreen);

            // 全螢幕狀態變化監聽
            document.addEventListener('fullscreenchange', handleFullscreenChange);

            // 預設時間按鈕
            presetBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const minutes = parseInt(this.dataset.minutes);
                    resetTimer(minutes);
                    showMessageBox(`已切換為 ${minutes} 分鐘，按「開始」計時！`);
                });
            });

            // 聲音開關圖示
            iconToggleTicking.addEventListener('click', () => handleIconToggle(iconToggleTicking, toggleTicking));
            iconToggleAlarm.addEventListener('click', () => handleIconToggle(iconToggleAlarm, toggleAlarm));
            iconToggleSpeech.addEventListener('click', () => handleIconToggle(iconToggleSpeech, toggleSpeech));
        }

        // --- 啟動初始化 ---

        function init() {
            loadSettings();
            setupSidebarInputs(); // 首次執行以選擇正確的輸入框
            updateTimerDisplay();
            updateButtonStates();
            attachEventListeners();
            
            // 實時時間每秒更新
            setInterval(updateCurrentTime, 1000);
            updateCurrentTime(); // 立即更新一次
        }

        // 頁面載入後啟動
        window.onload = init;

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å®šæœŸè©•é‡å¯¦æ™‚ç‹€æ…‹æ­ç¤ºæ¿</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // å¼·åˆ¶å•Ÿç”¨ class æ¨¡å¼çš„æš—è‰²ä¸»é¡Œ
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    :root {
      --bg: #0b1220; /* è¿‘ä¼¼ slate-950 */
      --panel: #0f172a; /* slate-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --ring: #22d3ee; /* cyan-400 */
      --accent: #38bdf8; /* sky-400 */
      --accent-2: #a78bfa; /* violet-400 */
      --good: #34d399; /* emerald-400 */
      --warn: #fbbf24; /* amber-400 */
      --bad: #f87171; /* red-400 */
    }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
    .main-container { max-width: 90rem; height: 100%; padding: 1.25rem; margin: 0 auto; display: flex; flex-direction: column; gap: 1rem; }
    textarea { min-height: 80px; resize: vertical; }
    /* æ™‚é–“è»¸æ¨£å¼ï¼ˆæš—è‰²ï¼‰ */
    .timeline-item { position: relative; padding-left: 1rem; border-left: 2px solid rgba(148,163,184,.25); margin-left: .25rem; }
    .timeline-item.active { border-left-color: var(--bad); background: rgba(248,113,113,.08); }
    .timeline-indicator { position: absolute; left: -9px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; background: var(--accent); border-radius: 9999px; z-index: 10; border: 3px solid var(--panel); }
    .timeline-item.active .timeline-indicator { background: var(--bad); box-shadow: 0 0 10px rgba(248,113,113,.6); }
    .schedule-list { overflow-y: auto; flex-grow: 1; }
    .glass { backdrop-filter: blur(6px); background: rgba(15,23,42,.6); }
    .card { background: var(--panel); border: 1px solid rgba(148,163,184,.12); }
    .btn { @apply inline-flex items-center justify-center rounded-lg font-bold transition-colors px-3 py-1 text-sm; }
    .btn-sky { background: #0ea5e9; color: #0b1220; }
    .btn-sky:hover { background: #38bdf8; }
    .btn-teal { background: #14b8a6; color: #052e2b; }
    .btn-teal:hover { background: #2dd4bf; }
    .btn-gray { background: #334155; color: #e2e8f0; }
    .btn-gray:hover { background: #475569; }
    .ring-focus { outline: none; box-shadow: 0 0 0 3px rgba(34,211,238,.35); }
    /* è®“ exam é¡å‹çš„å­—é«”æ›´å¤§ã€æ›´é†’ç›® */
    .timeline-item[data-index][data-type="exam"] .text-sm,
    .timeline-item.exam .text-sm {
      font-size: 1.125rem; /* text-lg */
      font-weight: 700; /* åŠ ç²— */
      color: var(--accent); /* sky-400 é¡è‰² */
    }
    
    .timeline-item.exam.active .text-sm {
      color: var(--bad); /* ç•¶å‰è€ƒè©¦é …ç›®æ™‚è®Šç´… */
    }
  </style>
</head>
<body onload="init()">
  <!-- ç‹€æ…‹æç¤º -->
  <div id="status-message" aria-live="polite" class="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 text-sm text-white rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0 pointer-events-none glass">
    æ“ä½œæˆåŠŸï¼
  </div>

  <!-- ç¼ºè€ƒ Base64 åŒ¯å…¥ Modal -->
  <div id="import-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-md">
      <h3 class="text-xl font-bold text-red-300 mb-3">åŒ¯å…¥ç¼ºè€ƒåº§è™Ÿè³‡æ–™</h3>
      <p class="text-sm text-slate-300 mb-3">è«‹å°‡ Base64 ç·¨ç¢¼çš„è³‡æ–™è²¼å…¥ä¸‹æ–¹æ–‡å­—æ¡†ï¼š</p>
      <textarea id="import-data-textarea" class="w-full h-28 p-2 rounded-lg bg-slate-800/70 border border-slate-600 text-slate-100 focus:ring-focus" placeholder="è²¼ä¸Š Base64 è³‡æ–™..."></textarea>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btn-import-cancel" class="btn btn-gray">å–æ¶ˆ</button>
        <button id="btn-import-confirm" class="btn bg-rose-500 hover:bg-rose-400 text-slate-900">ç¢ºèªåŒ¯å…¥</button>
      </div>
    </div>
  </div>

  <!-- æ’ç¨‹ CSV åŒ¯å…¥ Modal -->
  <div id="schedule-import-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-2xl">
      <h3 class="text-xl font-bold text-cyan-300 mb-3">åŒ¯å…¥æ®µè€ƒæ’ç¨‹è³‡æ–™ï¼ˆCSVï¼‰</h3>
      <p class="text-sm text-slate-300 mb-2">è«‹å°‡ <strong>CSV æª”æ¡ˆçš„å®Œæ•´å…§å®¹</strong> è²¼å…¥ä¸‹æ–¹æ–‡å­—æ¡†ï¼ˆéœ€åŒ…å«æ¨™é¡Œåˆ—ï¼‰ã€‚</p>
      <p class="text-xs text-cyan-300 mb-3">CSV æ¨™é¡Œåˆ—ï¼šDayKey,DayName,StartTime,EndTime,SubjectName,ActivityType</p>
      <textarea id="schedule-import-data-textarea" class="w-full h-48 p-2 rounded-lg bg-slate-800/70 border border-slate-600 text-slate-100 focus:ring-focus text-sm" placeholder="è²¼ä¸Š CSV å…§å®¹..."></textarea>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btn-schedule-cancel" class="btn btn-gray">å–æ¶ˆ</button>
        <button id="btn-schedule-confirm" class="btn btn-teal">ç¢ºèªåŒ¯å…¥ä¸¦å–ä»£</button>
      </div>
    </div>
  </div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="main-container">
    <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
    <div class="card p-4 rounded-2xl shadow-md border-b-2 border-b-sky-500 flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <h1 id="page-title" class="text-xl md:text-2xl font-extrabold text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 rounded px-1" contenteditable="true" title="é»æ“Šå³å¯ç·¨è¼¯æ¨™é¡Œ">114å¹´åº¦ç¬¬ä¸€æ¬¡å®šæœŸè©•é‡</h1>
        <button id="btn-fullscreen" class="btn btn-gray" aria-pressed="false" title="åˆ‡æ›å…¨è¢å¹•">â¤¢ å…¨è¢å¹•</button>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <div id="day-buttons-container" class="flex gap-2"></div>
        <button id="btn-sample" class="btn btn-gray">ä¸‹è¼‰ CSV ç¯„ä¾‹</button>
        <button id="btn-export" class="btn btn-teal">åŒ¯å‡ºæ’ç¨‹ (CSV)</button>
        <button id="btn-import" class="btn btn-sky">åŒ¯å…¥æ’ç¨‹ (CSV)</button>
      </div>
    </div>

    <!-- å…§å®¹å€ -->
    <div class="flex-grow flex flex-col lg:flex-row gap-4 min-h-0">
      <!-- å·¦å´ -->
      <div class="w-full lg:w-2/3 flex flex-col gap-4 min-h-0">
        <!-- å¯¦æ™‚ç‹€æ…‹å¡ç‰‡ -->
        <div class="card p-6 rounded-2xl border-t-2 border-t-cyan-500">
          <p class="text-base text-slate-300">
            ç›®å‰æ—¥æœŸï¼š<span id="current-schedule-date" class="font-semibold text-cyan-300">(è¼‰å…¥ä¸­...)</span>
          </p>
          <div id="current-datetime" class="text-xl md:text-xl font-extrabold mt-1 tracking-tight">
            --:--:--
          </div>
        </div>

        <!-- ç•¶å‰è€ƒç§‘é¡¯ç¤º -->
        <main id="hero" class="flex-grow flex flex-col justify-center items-center rounded-2xl shadow-xl p-8 transition-colors duration-300" style="background: linear-gradient(145deg, rgba(2,132,199,.15), rgba(67,56,202,.12));">
          <h2 class="text-2xl md:text-3xl font-bold text-slate-200 mb-4">ç›®å‰é€²è¡Œè€ƒç§‘</h2>
          <div class="rounded-2xl shadow-inner px-6 py-5 bg-slate-900/60 border border-slate-700">
            <p id="current-subject" class="text-5xl md:text-6xl font-black text-center text-sky-300">-- ç­‰å¾…æ’ç¨‹ --</p>
          </div>
          <p id="subject-time-range" class="mt-4 text-lg md:text-2xl font-medium text-slate-300">( --:-- è‡³ --:-- )</p>
          <div class="w-full max-w-xl mt-6 bg-slate-800 rounded-full h-4 shadow-inner overflow-hidden">
            <div id="subject-progress-bar" class="h-full rounded-full flex items-center justify-end pr-2 font-bold transition-all duration-700 bg-amber-400 text-slate-900" style="width:0%">
              <span id="subject-progress-text" class="text-xs">0%</span>
            </div>
          </div>
        </main>

        <!-- ç¼ºè€ƒå€å¡Š -->
        <section class="card p-5 rounded-2xl border border-rose-400/30">
          <div class="cursor-pointer flex justify-between items-center mb-3 p-2 rounded-md hover:bg-slate-800/50" id="toggle-absent">
            <h2 class="text-2xl font-semibold text-rose-300 flex items-center">
              ç¼ºè€ƒåº§è™Ÿè¿½è¹¤
              <svg id="toggle-icon" class="w-6 h-6 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </h2>
          </div>

          <div class="grid grid-cols-3 gap-3 mb-4 text-center">
            <div class="bg-slate-800/70 p-2 rounded-lg border border-slate-700">
              <p class="text-xs font-medium text-slate-300">æ‡‰åˆ°äººæ•¸</p>
              <p id="expected-count" class="text-5xl md:text-6xl font-bold text-slate-100">30</p>
            </div>
            <div class="bg-rose-900/30 p-2 rounded-lg border border-rose-500/30">
              <p class="text-xs font-medium text-rose-300">ç¼ºè€ƒäººæ•¸</p>
              <p id="absent-count" class="text-5xl md:text-6xl font-bold text-rose-200">0</p>
            </div>
            <div class="bg-emerald-900/30 p-2 rounded-lg border border-emerald-500/30">
              <p class="text-xs font-medium text-emerald-300">å¯¦åˆ°äººæ•¸</p>
              <p id="actual-count" class="text-5xl md:text-6xl font-bold text-emerald-200">30</p>
            </div>
          </div>

          <div class="mt-3 p-3 bg-slate-900/60 border border-rose-500/20 rounded-md">
            <p class="font-medium text-rose-300 mb-1 text-sm">ç›®å‰ç¼ºè€ƒåº§è™Ÿï¼š</p>
            <div id="absent-seat-display" class="text-lg font-extrabold text-rose-200">å°šç„¡ç¼ºè€ƒè¨˜éŒ„ã€‚</div>
          </div>

          <div id="absent-input-area" class="mt-4">
            <p class="text-slate-300 mb-2 text-xs">è«‹å¡«å¯«ç¼ºè€ƒåº§è™Ÿï¼ˆå¯ç”¨é€—è™Ÿã€ç©ºæ ¼æˆ–æ›è¡Œåˆ†éš”ï¼‰ï¼š</p>
            <textarea id="absent-seat-input" class="w-full p-2 rounded-lg bg-slate-800/70 border border-rose-400/40 text-slate-100 focus:ring-focus" placeholder="ä¾‹å¦‚ï¼š1, 5, 12, 25"></textarea>
            <div class="flex justify-end gap-2 mt-2">
              <button id="btn-absent-export" class="btn bg-rose-500 hover:bg-rose-400 text-slate-900">åŒ¯å‡º (è¤‡è£½ Base64)</button>
              <button id="btn-absent-import" class="btn bg-rose-400/80 hover:bg-rose-400 text-slate-900">åŒ¯å…¥ (å½ˆçª—è²¼ä¸Š)</button>
            </div>
          </div>
        </section>
      </div>

      <!-- å³å´ï¼šæ’ç¨‹æ¦‚è¦½ -->
      <div class="w-full lg:w-1/3 card p-6 rounded-2xl shadow-xl flex flex-col min-h-0">
        <h2 id="schedule-title" class="text-2xl font-bold text-slate-100 mb-4 pb-2 border-b border-slate-700 flex-shrink-0">
          æ’ç¨‹æ¦‚è¦½
        </h2>
        <div id="schedule-timeline" class="schedule-list space-y-4">
          <h3 class="sticky top-0 z-10 text-lg font-bold text-sky-300 p-1 border-b border-slate-700 bg-slate-900/70 backdrop-blur">â˜€ï¸ ä¸Šåˆæ™‚æ®µ</h3>
          <div id="morning-schedule" class="space-y-2"></div>
          <div id="lunch-break-item" class="p-2 my-2 rounded-md text-center text-slate-200 font-semibold text-sm flex-shrink-0 bg-slate-800 border border-slate-700">
            åˆä¼‘æ™‚é–“ (11:45 - 13:05)
          </div>
          <h3 class="sticky top-[38px] z-10 text-lg font-bold text-violet-300 p-1 border-b border-slate-700 bg-slate-900/70 backdrop-blur">ğŸŒ™ ä¸‹åˆæ™‚æ®µ</h3>
          <div id="afternoon-schedule" class="space-y-2"></div>
        </div>
        <p class="text-[11px] text-slate-400 mt-3 text-center">æ™‚é–“æŒçºŒæ›´æ–°ä¸­â€¦</p>
      </div>
    </div>
  </div>

  <script>
    // ===== å¸¸é‡èˆ‡ç‹€æ…‹ =====
    const EXPECTED_COUNT = 30;
    let isAbsentInputVisible = true;

    let initialSchedules = {
      'day1': {
        name: '10/16 æ˜ŸæœŸå››',
        data: [
          { start: '08:10', end: '08:50', name: 'è‡ªç¿’æº–å‚™ (40åˆ†)', type: 'study' },
          { start: '08:50', end: '09:00', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '09:00', end: '10:00', name: 'æ•¸å­¸ (60åˆ†)', type: 'exam' },
          { start: '10:00', end: '10:10', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '10:10', end: '10:40', name: 'è‡ªç¿’ (30åˆ†)', type: 'study' },
          { start: '10:40', end: '10:55', name: 'ä¼‘æ¯ (15åˆ†)', type: 'break' },
          { start: '10:55', end: '11:45', name: 'åœ‹æ–‡ (50åˆ†)', type: 'exam' },
          { start: '11:45', end: '13:05', name: 'åˆä¼‘æ™‚é–“ (80åˆ†)', type: 'break' },
          { start: '13:05', end: '13:50', name: 'è‹±èª (45åˆ†)', type: 'exam' },
          { start: '13:50', end: '14:00', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '14:00', end: '15:00', name: 'è‡ªç„¶ (60åˆ†)', type: 'exam' },
          { start: '15:00', end: '15:10', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '15:10', end: '15:40', name: 'è‡ªç¿’/æ‰“æƒ (30åˆ†)', type: 'study' },
          { start: '15:40', end: '16:00', name: 'ä»Šæ—¥æ’ç¨‹çµæŸ', type: 'end' },
        ],
      },
      'day2': {
        name: '10/17 æ˜ŸæœŸäº”',
        data: [
          { start: '08:10', end: '08:40', name: 'è‡ªç¿’æº–å‚™ (30åˆ†)', type: 'study' },
          { start: '08:40', end: '08:50', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '08:50', end: '09:50', name: 'ç¤¾æœƒ (60åˆ†)', type: 'exam' },
          { start: '09:50', end: '10:00', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '10:00', end: '10:30', name: 'è‡ªç¿’ (30åˆ†)', type: 'study' },
          { start: '10:30', end: '10:45', name: 'ä¼‘æ¯ (15åˆ†)', type: 'break' },
          { start: '10:45', end: '11:45', name: 'ç¶œåˆæ´»å‹• (60åˆ†)', type: 'exam' },
          { start: '11:45', end: '13:05', name: 'åˆä¼‘æ™‚é–“ (80åˆ†)', type: 'break' },
          { start: '13:05', end: '13:50', name: 'å¥åº·æ•™è‚² (45åˆ†)', type: 'exam' },
          { start: '13:50', end: '14:00', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '14:00', end: '14:30', name: 'è‡ªç¿’ (30åˆ†)', type: 'study' },
          { start: '14:30', end: '14:40', name: 'ä¼‘æ¯ (10åˆ†)', type: 'break' },
          { start: '14:40', end: '15:40', name: 'å½ˆæ€§èª²ç¨‹ (60åˆ†)', type: 'exam' },
          { start: '15:40', end: '16:00', name: 'ä»Šæ—¥æ’ç¨‹çµæŸ', type: 'end' },
        ],
      },
    };

    let currentDay = 'day1';
    let currentScheduleData = initialSchedules[currentDay];

    // ===== DOM å¿«å– =====
    const el = (id) => document.getElementById(id);
    const currentDatetimeEl = el('current-datetime');
    const currentScheduleDateEl = el('current-schedule-date');
    const currentSubjectEl = el('current-subject');
    const subjectTimeRangeEl = el('subject-time-range');
    const subjectProgressBarEl = el('subject-progress-bar');
    const subjectProgressTextEl = el('subject-progress-text');

    const morningScheduleEl = el('morning-schedule');
    const afternoonScheduleEl = el('afternoon-schedule');
    const lunchBreakItemEl = el('lunch-break-item');

    const absentInput = el('absent-seat-input');
    const absentDisplay = el('absent-seat-display');
    const absentInputArea = el('absent-input-area');
    const absentCountEl = el('absent-count');
    const actualCountEl = el('actual-count');
    const expectedCountEl = el('expected-count');
    const toggleIconEl = el('toggle-icon');

    const importDataTextarea = el('import-data-textarea');
    const importModal = el('import-modal');
    const statusMessageEl = el('status-message');

    const scheduleImportModal = el('schedule-import-modal');
    const scheduleImportDataTextarea = el('schedule-import-data-textarea');
    const dayButtonsContainer = el('day-buttons-container');

    // é ‚éƒ¨æŒ‰éˆ•
    const btnSample = el('btn-sample');
    const btnExport = el('btn-export');
    const btnImport = el('btn-import');

    // å…¨è¢å¹•èˆ‡å¯ç·¨è¼¯æ¨™é¡Œ
    const btnFullscreen = el('btn-fullscreen');
    const pageTitleEl = el('page-title');

    // ç¼ºè€ƒæŒ‰éˆ•
    const btnAbsentExport = el('btn-absent-export');
    const btnAbsentImport = el('btn-absent-import');

    // Modal æŒ‰éˆ•
    const btnImportCancel = el('btn-import-cancel');
    const btnImportConfirm = el('btn-import-confirm');
    const btnScheduleCancel = el('btn-schedule-cancel');
    const btnScheduleConfirm = el('btn-schedule-confirm');

    // ===== å·¥å…·å‡½å¼ =====
    const parseTime = (timeStr) => {
      const [h, m] = timeStr.split(':').map(Number);
      const d = new Date();
      d.setHours(h, m, 0, 0);
      return d;
    };

    const within = (now, start, end) => now >= start && now < end;

    function getSplitSchedules(scheduleData) {
      const lunchIndex = scheduleData.findIndex((i) => i.start === '11:45' && i.end === '13:05');
      if (lunchIndex === -1) return { morning: scheduleData, lunch: null, afternoon: [] };
      return { morning: scheduleData.slice(0, lunchIndex), lunch: scheduleData[lunchIndex], afternoon: scheduleData.slice(lunchIndex + 1) };
    }

    function renderScheduleSegment(schedule, targetEl, startIndex) {
      targetEl.innerHTML = '';
      schedule.forEach((item, idx) => {
        const originalIndex = startIndex + idx;
        let colorClass = 'text-slate-200';
        let icon = 'ğŸ';
        if (item.type === 'exam') { colorClass = 'text-sky-300 font-semibold'; icon = 'ğŸ“'; }
        else if (item.type === 'study') { colorClass = 'text-violet-300'; icon = 'ğŸ“š'; }
        else if (item.type === 'break') { colorClass = 'text-emerald-300'; icon = 'â˜•'; }

        const html = `
          <div id="schedule-item-${originalIndex}" class="timeline-item ${item.type}" data-type="${item.type}" data-index="${originalIndex}">
            <div class="timeline-indicator"></div>
            <div class="flex items-center gap-2">
              <div class="text-xs font-bold w-12 flex-shrink-0 text-slate-400">${item.start}</div>
              <div class="flex-grow">
                <div class="text-sm ${colorClass}">${icon} ${item.name}</div>
                <div class="text-[11px] text-slate-500">çµæŸ: ${item.end}</div>
              </div>
            </div>
          </div>`;
        targetEl.insertAdjacentHTML('beforeend', html);
      });
    }

    function renderDayButtons() {
      dayButtonsContainer.innerHTML = '';
      const dayKeys = Object.keys(initialSchedules).sort();
      dayKeys.forEach((day) => {
        const schedule = initialSchedules[day];
        const isActive = day === currentDay;
        const btn = document.createElement('button');
        btn.id = `${day}-btn`;
        btn.textContent = schedule.name;
        btn.className = `btn ${isActive ? 'bg-indigo-500 text-white' : 'btn-gray'}`;
        btn.addEventListener('click', () => loadSchedule(day));
        dayButtonsContainer.appendChild(btn);
      });
    }

    function loadSchedule(day) {
      if (!initialSchedules[day]) {
        const first = Object.keys(initialSchedules)[0];
        if (!first) {
          currentScheduleData = null; renderDayButtons(); renderSchedule(); updateDisplay(); return;
        }
        day = first;
      }
      currentDay = day;
      currentScheduleData = initialSchedules[currentDay];
      currentScheduleData.split = getSplitSchedules(currentScheduleData.data);
      renderDayButtons();
      currentScheduleDateEl.textContent = ` (${currentScheduleData.name})`;
      document.getElementById('schedule-title').textContent = `æ’ç¨‹æ¦‚è¦½ (${currentScheduleData.name})`;
      renderSchedule();
      updateDisplay();
    }

    function renderSchedule() {
      if (!currentScheduleData || !currentScheduleData.data) {
        morningScheduleEl.innerHTML = '<p class="text-center text-slate-400">ç„¡æ’ç¨‹è³‡æ–™</p>';
        afternoonScheduleEl.innerHTML = '';
        lunchBreakItemEl.textContent = 'åˆä¼‘æ™‚é–“';
        lunchBreakItemEl.classList.remove('bg-slate-800');
        return;
      }
      const { morning, lunch, afternoon } = currentScheduleData.split;
      renderScheduleSegment(morning, morningScheduleEl, 0);
      const lunchIndex = currentScheduleData.data.findIndex((i) => i === lunch);
      const afternoonStartIndex = lunchIndex !== -1 ? lunchIndex + 1 : morning.length;
      renderScheduleSegment(afternoon, afternoonScheduleEl, afternoonStartIndex);
      if (lunch) {
        const dur = Math.floor((parseTime(lunch.end) - parseTime(lunch.start)) / 60000);
        lunchBreakItemEl.innerHTML = `åˆä¼‘æ™‚é–“ ${lunch.start} - ${lunch.end} (${dur} åˆ†)`;
        lunchBreakItemEl.dataset.start = lunch.start;
        lunchBreakItemEl.dataset.end = lunch.end;
        lunchBreakItemEl.id = `schedule-item-${lunchIndex}`;
        lunchBreakItemEl.classList.add('bg-slate-800');
      } else {
        lunchBreakItemEl.classList.add('hidden');
      }
    }

    function updateAbsentSeats() {
      const raw = absentInput.value;
      const cleaned = raw.replace(/[,ï¼Œ\s\n]+/g, ' ').trim();
      const nums = cleaned.split(' ').map((s) => s.trim()).filter((s) => s && /^\d+$/.test(s)).map(Number).sort((a,b)=>a-b);
      const unique = [...new Set(nums)];
      const absentCount = unique.length;
      const actual = EXPECTED_COUNT - absentCount;
      absentDisplay.textContent = absentCount ? unique.join('ã€ ') : 'å°šç„¡ç¼ºè€ƒè¨˜éŒ„ã€‚';
      expectedCountEl.textContent = EXPECTED_COUNT;
      absentCountEl.textContent = absentCount;
      actualCountEl.textContent = actual;
      // æŒä¹…åŒ–
      localStorage.setItem('absentSeats', raw);
    }

    function toggleAbsentInput() {
      isAbsentInputVisible = !isAbsentInputVisible;
      if (isAbsentInputVisible) { absentInputArea.classList.remove('hidden'); toggleIconEl.classList.remove('rotate-180'); }
      else { absentInputArea.classList.add('hidden'); toggleIconEl.classList.add('rotate-180'); }
    }

    function showStatusMessage(message, isError = false) {
      statusMessageEl.textContent = message;
      statusMessageEl.classList.remove('opacity-0');
      statusMessageEl.style.background = isError ? 'rgba(244,63,94,.9)' : 'rgba(16,185,129,.9)';
      statusMessageEl.style.pointerEvents = 'auto';
      clearTimeout(window.__statusTimer);
      window.__statusTimer = setTimeout(() => {
        statusMessageEl.classList.add('opacity-0');
        statusMessageEl.style.pointerEvents = 'none';
      }, 2500);
    }

    // ===== åŒ¯å‡º/åŒ¯å…¥ï¼šç¼ºè€ƒ =====
    function exportAbsentSeats() {
      const raw = absentInput.value;
      if (!raw.trim()) return showStatusMessage('æ²’æœ‰ç¼ºè€ƒåº§è™Ÿå¯åŒ¯å‡ºã€‚', true);
      const encoded = btoa(encodeURIComponent(raw));
      navigator.clipboard?.writeText(encoded).then(() => {
        showStatusMessage('ç¼ºè€ƒåº§è™Ÿè³‡æ–™å·²ç·¨ç¢¼ä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
      }).catch(() => {
        // å¾Œå‚™æ–¹æ¡ˆ
        const t = document.createElement('textarea');
        t.value = encoded; document.body.appendChild(t); t.select();
        const ok = document.execCommand('copy'); document.body.removeChild(t);
        showStatusMessage(ok ? 'ç¼ºè€ƒåº§è™Ÿè³‡æ–™å·²ç·¨ç¢¼ä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼' : 'è¤‡è£½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚', !ok);
      });
    }

    function openImportModal() { importModal.classList.remove('hidden'); importDataTextarea.value=''; setTimeout(()=>importDataTextarea.focus(),0); }
    function closeImportModal() { importModal.classList.add('hidden'); }
    function confirmImport() {
      const base64Data = importDataTextarea.value.trim();
      closeImportModal();
      if (!base64Data) return showStatusMessage('åŒ¯å…¥å–æ¶ˆæˆ–ç„¡è³‡æ–™ã€‚', true);
      try {
        const decoded = decodeURIComponent(atob(base64Data));
        absentInput.value = decoded; updateAbsentSeats();
        showStatusMessage('ç¼ºè€ƒåº§è™ŸåŒ¯å…¥æˆåŠŸï¼');
      } catch (e) { console.error(e); showStatusMessage('åŒ¯å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–ç„¡æ•ˆã€‚', true); }
    }

    // ===== CSVï¼šæ’ç¨‹ =====
    function convertToCsv(schedules) {
      const header = 'DayKey,DayName,StartTime,EndTime,SubjectName,ActivityType\n';
      let csv = header;
      Object.keys(schedules).sort().forEach((key) => {
        const sc = schedules[key];
        sc.data.forEach((item) => {
          const row = [
            key,
            `"${sc.name.replace(/"/g,'""')}"`,
            item.start,
            item.end,
            `"${item.name.replace(/"/g,'""')}"`,
            item.type,
          ].join(',');
          csv += row + '\n';
        });
      });
      return '\ufeff' + csv; // BOM
    }

    function parseCsv(csvString) {
      const schedules = {};
      csvString = csvString.replace(/^\ufeff/, '');
      const lines = csvString.split('\n').filter((l) => l.trim() !== '');
      if (lines.length < 2) throw new Error('CSV å…§å®¹ä¸è¶³ï¼Œè«‹ç¢ºèªæ¨™é¡Œåˆ—èˆ‡è³‡æ–™åˆ—ã€‚');
      const dataLines = lines.slice(1);
      dataLines.forEach((line, i) => {
        const values = line.match(/(?:[^,"]+|"[^"]*")+/g)?.map((v) => v.trim().replace(/^"|"$/g,'').replace(/""/g,'"')) || [];
        if (values.length !== 6) { console.warn(`Line ${i+2} æ¬„ä½æ•¸ä¸ç¬¦ï¼Œå·²ç•¥éï¼š`, line); return; }
        const [DayKey, DayName, StartTime, EndTime, SubjectName, ActivityType] = values;
        if (!/^\d{2}:\d{2}$/.test(StartTime) || !/^\d{2}:\d{2}$/.test(EndTime)) throw new Error(`ç¬¬ ${i+2} è¡Œæ™‚é–“æ ¼å¼éŒ¯èª¤ï¼š${StartTime}-${EndTime}`);
        if (!['exam','break','study','end'].includes(ActivityType)) throw new Error(`ç¬¬ ${i+2} è¡Œæ´»å‹•é¡å‹éŒ¯èª¤ï¼š${ActivityType}`);
        if (!schedules[DayKey]) schedules[DayKey] = { name: DayName, data: [] };
        schedules[DayKey].data.push({ start: StartTime, end: EndTime, name: SubjectName, type: ActivityType });
      });
      return schedules;
    }

    function downloadFile(content, fileName, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fileName; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function exportScheduleData() {
      if (!Object.keys(initialSchedules).length) return showStatusMessage('æ’ç¨‹è³‡æ–™ç‚ºç©ºï¼Œè«‹å…ˆåŒ¯å…¥æˆ–å»ºç«‹æ’ç¨‹ã€‚', true);
      const csv = convertToCsv(initialSchedules);
      downloadFile(csv, 'exam_schedule.csv', 'text/csv;charset=utf-8;');
      showStatusMessage('æ’ç¨‹è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºç‚º exam_schedule.csvï¼');
    }

    function downloadSampleCsv() {
      const csv = convertToCsv(initialSchedules);
      downloadFile(csv, 'exam_schedule_sample.csv', 'text/csv;charset=utf-8;');
      showStatusMessage('CSV ç¯„ä¾‹æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
    }

    function openScheduleImport() { scheduleImportModal.classList.remove('hidden'); scheduleImportDataTextarea.value=''; setTimeout(()=>scheduleImportDataTextarea.focus(),0); }
    function closeScheduleImport() { scheduleImportModal.classList.add('hidden'); }
    function confirmScheduleImport() {
      const csv = scheduleImportDataTextarea.value.trim();
      closeScheduleImport();
      if (!csv) return showStatusMessage('æ’ç¨‹åŒ¯å…¥å–æ¶ˆæˆ–ç„¡è³‡æ–™ã€‚', true);
      try {
        const newSchedules = parseCsv(csv);
        if (!Object.keys(newSchedules).length) throw new Error('è§£æå¾Œæœªå¾—åˆ°ä»»ä½•æœ‰æ•ˆçš„æ’ç¨‹è³‡æ–™ã€‚');
        initialSchedules = newSchedules; // ç›´æ¥å–ä»£ï¼ˆç°¡åŒ–ï¼‰
        const first = Object.keys(initialSchedules).sort()[0];
        loadSchedule(first);
        showStatusMessage(`æ’ç¨‹åŒ¯å…¥æˆåŠŸï¼å·²è¼‰å…¥ ${Object.keys(initialSchedules).length} å¤©æ’ç¨‹ã€‚`);
        // æŒä¹…åŒ–ï¼ˆå¯é¸ï¼‰
        localStorage.setItem('schedulesCSV', csv);
      } catch (e) { console.error(e); showStatusMessage(`æ’ç¨‹åŒ¯å…¥å¤±æ•—ï¼š${e.message}`, true); }
    }

    // ===== ä¸»æ›´æ–° =====
    function updateDisplay() {
      if (!currentScheduleData || !currentScheduleData.data) {
        currentSubjectEl.textContent = 'ç„¡æ’ç¨‹è³‡æ–™';
        subjectTimeRangeEl.textContent = '---';
        subjectProgressBarEl.style.width = '0%';
        subjectProgressTextEl.textContent = '0%';
        return;
      }
      const schedule = currentScheduleData.data;
      const now = new Date();
      const fmt = { year:'numeric', month:'long', day:'numeric', weekday:'long', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
      currentDatetimeEl.textContent = now.toLocaleDateString('zh-TW', fmt);

      let currentItem = null, currentIndex = -1, pct = 0;
      document.querySelectorAll('.timeline-item').forEach((el) => {
        el.classList.remove('active');
      });
      for (let i = 0; i < schedule.length; i++) {
        const item = schedule[i];
        const s = parseTime(item.start), e = parseTime(item.end);
        if (within(now, s, e)) { currentItem = item; currentIndex = i; pct = Math.min(100, Math.round(((now - s) / (e - s)) * 100)); break; }
      }

      const hero = document.getElementById('hero');
      if (currentItem) {
        currentSubjectEl.textContent = currentItem.name;
        subjectTimeRangeEl.textContent = `(${currentItem.start} è‡³ ${currentItem.end})`;
        subjectProgressBarEl.style.width = pct + '%';
        subjectProgressTextEl.textContent = pct + '%';

        // æ¼¸å±¤èˆ‡è‰²å½©æ ¹æ“š type èª¿æ•´
        if (currentItem.type === 'exam') hero.style.background = 'linear-gradient(145deg, rgba(14,165,233,.20), rgba(99,102,241,.18))';
        else if (currentItem.type === 'break') hero.style.background = 'linear-gradient(145deg, rgba(251,191,36,.20), rgba(34,197,94,.18))';
        else if (currentItem.type === 'study') hero.style.background = 'linear-gradient(145deg, rgba(167,139,250,.22), rgba(56,189,248,.18))';
        else hero.style.background = 'linear-gradient(145deg, rgba(148,163,184,.15), rgba(100,116,139,.15))';

        const itemEl = document.getElementById(`schedule-item-${currentIndex}`);
        if (itemEl) itemEl.classList.add('active');
      } else {
        currentSubjectEl.textContent = 'ä»Šæ—¥æ’ç¨‹å·²çµæŸ / å°šæœªé–‹å§‹';
        subjectTimeRangeEl.textContent = '---';
        subjectProgressBarEl.style.width = '0%';
        subjectProgressTextEl.textContent = '0%';
        hero.style.background = 'linear-gradient(145deg, rgba(148,163,184,.12), rgba(100,116,139,.12))';
      }
    }

    // ===== åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š =====
    function init() {
      const savedSeats = localStorage.getItem('absentSeats');
      if (savedSeats) { absentInput.value = savedSeats; }
      updateAbsentSeats();

      // è‹¥å…ˆå‰æœ‰å„²å­˜çš„ CSVï¼ˆå¯é¸ï¼‰
      const savedCSV = localStorage.getItem('schedulesCSV');
      if (savedCSV) {
        try { initialSchedules = parseCsv(savedCSV); } catch {}
      }
      const firstDayKey = Object.keys(initialSchedules).sort()[0];
      if (firstDayKey) loadSchedule(firstDayKey); else { renderDayButtons(); renderSchedule(); updateDisplay(); }

      // å®šæ™‚æ›´æ–°
      setInterval(updateDisplay, 1000);

      // äº‹ä»¶ç¶å®š
      document.getElementById('toggle-absent').addEventListener('click', toggleAbsentInput);
      absentInput.addEventListener('input', updateAbsentSeats);

      btnSample.addEventListener('click', downloadSampleCsv);
      btnExport.addEventListener('click', exportScheduleData);
      btnImport.addEventListener('click', openScheduleImport);

      btnAbsentExport.addEventListener('click', exportAbsentSeats);
      btnAbsentImport.addEventListener('click', openImportModal);

      btnImportCancel.addEventListener('click', closeImportModal);
      btnImportConfirm.addEventListener('click', confirmImport);

      btnScheduleCancel.addEventListener('click', closeScheduleImport);
      btnScheduleConfirm.addEventListener('click', confirmScheduleImport);

      // ===== å¯ç·¨è¼¯æ¨™é¡Œï¼šè¼‰å…¥èˆ‡å„²å­˜ =====
      const savedTitle = localStorage.getItem('pageTitle');
      if (savedTitle) pageTitleEl.textContent = savedTitle;
      pageTitleEl.addEventListener('input', () => {
        localStorage.setItem('pageTitle', pageTitleEl.textContent.trim());
      });

      // ===== å…¨è¢å¹•åˆ‡æ› =====
      function syncFsBtn() {
        const isFs = !!document.fullscreenElement;
        btnFullscreen.setAttribute('aria-pressed', isFs ? 'true' : 'false');
        btnFullscreen.textContent = isFs ? 'â¤¢ é€€å‡ºå…¨è¢å¹•' : 'â¤¢ å…¨è¢å¹•';
      }
      btnFullscreen.addEventListener('click', async () => {
        try {
          if (!document.fullscreenElement) {
            await document.documentElement.requestFullscreen();
          } else {
            await document.exitFullscreen();
          }
        } catch (e) { showStatusMessage('å…¨è¢å¹•åˆ‡æ›å¤±æ•—', true); }
      });
      document.addEventListener('fullscreenchange', syncFsBtn);
      syncFsBtn();
    
    }
  </script>
  <footer class="fixed bottom-2 right-4 text-[12px] text-slate-400/60 select-none">Developed by <span class="font-semibold">DennisZ</span></footer>
</body>
</html>


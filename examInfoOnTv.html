<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å®šæœŸè©•é‡å¯¦æ™‚ç‹€æ…‹æ­ç¤ºæ¿</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' };</script>
  <style>
    /* === v1.0.1 æ–°å¢/èª¿æ•´æ¨£å¼å€ === */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    :root{
      --bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--ring:#22d3ee;
      --accent:#38bdf8;--accent-2:#a78bfa;--good:#34d399;--warn:#fbbf24;--bad:#f87171;
    }
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
    .main-container{max-width:90rem;height:100%;padding:1.25rem;margin:0 auto;display:flex;flex-direction:column;gap:1rem}
    textarea{min-height:80px;resize:vertical}
    .timeline-item{position:relative;padding-left:1rem;border-left:2px solid rgba(148,163,184,.25);margin-left:.25rem}
    .timeline-item.active{border-left-color:var(--bad);background:rgba(248,113,113,.08)}
    .timeline-indicator{position:absolute;left:-9px;top:50%;transform:translateY(-50%);width:14px;height:14px;background:var(--accent);border-radius:9999px;z-index:10;border:3px solid var(--panel)}
    .timeline-item.active .timeline-indicator{background:var(--bad);box-shadow:0 0 10px rgba(248,113,113,.6)}
    .schedule-list{overflow-y:auto;flex-grow:1}
    .glass{backdrop-filter:blur(6px);background:rgba(15,23,42,.6)}
    .card{background:var(--panel);border:1px solid rgba(148,163,184,.12)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;font-weight:700;transition:background-color .15s ease,opacity .15s ease;padding:.25rem .75rem;font-size:.875rem}
    .btn-sky{background:#0ea5e9;color:#0b1220}.btn-sky:hover{background:#38bdf8}
    .btn-teal{background:#14b8a6;color:#052e2b}.btn-teal:hover{background:#2dd4bf}
    .btn-gray{background:#334155;color:#e2e8f0}.btn-gray:hover{background:#475569}
    .btn-rose{background:#f43f5e;color:#0b1220}.btn-rose:hover{background:#fb7185}
    .ring-focus{outline:none;box-shadow:0 0 0 3px rgba(34,211,238,.35)}
    .timeline-item[data-index][data-type="exam"] .text-sm,.timeline-item.exam .text-sm{font-size:1.125rem;font-weight:700;color:var(--accent)}
    .timeline-item.exam.active .text-sm{color:var(--bad)}
    #schedule-timeline .timeline-item.exam .text-sm,#schedule-timeline .timeline-item[data-type="exam"] .text-sm{font-size:1.125rem;font-weight:800}
    .modal{opacity:1}

    /* === å¤§æ™‚é˜ HUDï¼ˆåŸæ¨£å¼ï¼Œä¾›æœªé–å®šæ™‚ä½¿ç”¨ï¼‰ === */
    .clock-hud{
      position:fixed; z-index:55; user-select:none;
      background:rgba(2,6,23,.75);
      border:1px solid rgba(148,163,184,.25);
      backdrop-filter:blur(8px);
      box-shadow:0 8px 30px rgba(0,0,0,.35), 0 0 24px rgba(56,189,248,.18);
      border-radius:18px; padding:.5rem .75rem;
      display:flex; align-items:center; gap:.6rem;
      cursor:grab;
      transform: scale(var(--clock-scale, 2));
      transform-origin: top right;
    }
    .clock-hud.dragging{cursor:grabbing}
    .clock-time{font-weight:900; letter-spacing:.5px; text-shadow:0 0 12px rgba(56,189,248,.35);}
    .clock-date{font-size:.7rem;color:#cbd5e1}
    .clock-dot{animation:blink 1s steps(2,start) infinite}
    @keyframes blink{to{opacity:.2}}
    .clock-badge{font-size:.65rem; padding:.1rem .4rem; border-radius:9999px;background:rgba(56,189,248,.18); color:#bae6fd; border:1px solid rgba(56,189,248,.35)}
    .clock-actions button{font-size:.7rem; padding:.2rem .45rem; border-radius:.4rem;background:#0ea5e9; color:#06253a; font-weight:800;}
    .clock-actions button:hover{background:#38bdf8}
    .snap-tip{position:absolute; inset:auto auto -18px 0; font-size:.65rem; color:#94a3b8}
    #clock-hud{top:12px; right:16px}

    /* å±•ç¤ºæ¨¡å¼åŸæ¨£å¼ï¼ˆæœªé–å®šæ™‚ï¼‰ */
    #pres-clock{
      position:fixed; z-index:70; left:50%; transform:translateX(-50%) scale(var(--clock-scale, 2));
      top:70px; color:snow;
      cursor:default; user-select:none; padding:.75rem 1.25rem;
      border-radius:22px; backdrop-filter:blur(10px);
      background:linear-gradient(180deg, rgba(2,8,23,.75), rgba(2,8,23,.6));
      border:5px solid rgba(148,163,184,.25);
      box-shadow:
        0 10px 35px rgba(0,0,0,.45),
        0 0 0 1px rgba(56,189,248,.18) inset,
        0 0 32px rgba(56,189,248,.25);
    }
    @media (min-width: 768px){
      #clock-hud .clock-time{font-size:1.5rem}
      #pres-clock .clock-time{font-size:5rem}
    }
    @media (max-width: 767px){
      #clock-hud .clock-time{font-size:1.25rem}
      #pres-clock .clock-time{font-size:4rem}
    }

    /* === Clock é–å®šæ¨¡å¼ï¼šåµŒå…¥ï¼ˆé¿å…é®æ“‹ï¼‰ï¼Œä¸”éš±è—æ“ä½œéˆ• === */
    .clock-hud.docked {
      position: static !important;
      z-index: auto !important;
      transform: none !important;
      transform-origin: initial !important;
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
      padding: 0 !important;
      cursor: default !important;
    }
    .clock-hud.docked .clock-time { font-size: 1.125rem; }
    .clock-hud.docked .clock-date { font-size: .75rem; }
    .clock-hud .clock-actions, .clock-hud .snap-tip { display: none !important; }
	
	@import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap');

	/* è®“æ•¸å­—å›ºå®šå­—å¯¬ + å‹å–„ fallback */
	.clock-time,
	#pres-clock .clock-time {
	  font-variant-numeric: tabular-nums lining-nums;
	  font-feature-settings: "tnum","lnum";
	  font-family: 'Inter', 'Roboto Mono', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', sans-serif;
	  letter-spacing: .02em;
	}

	/* ä¿ç•™ç‰ˆä½ï¼šæ•¸å­— 2chã€å†’è™Ÿ 1ch */
	#hud-hh, #hud-mm, #hud-ss,
	#pres-hh, #pres-mm, #pres-ss {
	  display: inline-block;
	  width: 2ch;
	  text-align: center;
	}

	.clock-dot {
	  display: inline-block;
	  width: 1ch;
	  text-align: center;
	}

  </style>
</head>
<body onload="init()">
  <!-- ç‹€æ…‹æç¤º -->
  <div id="status-message" aria-live="polite" class="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 text-sm text-white rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0 pointer-events-none glass">
    æ“ä½œæˆåŠŸï¼
  </div>

  <!-- ä¸€èˆ¬æ¨¡å¼ å¤§æ™‚é˜ï¼ˆå°‡è¢«åµŒå…¥é ‚éƒ¨æ§åˆ¶åˆ—å³å´ï¼‰ -->
  <div id="clock-hud" class="clock-hud">
    <div class="clock-badge">ç¾åœ¨</div>
    <div class="flex flex-col leading-tight">
      <div class="clock-time">
        <span id="hud-hh">--</span><span class="clock-dot">:</span><span id="hud-mm">--</span><span class="clock-dot">:</span><span id="hud-ss">--</span>
      </div>
      <div id="hud-date" class="clock-date">--</div>
    </div>
    <div class="clock-actions hidden md:flex gap-1">
      <button id="hud-cycle">â‡²</button>
      <button id="hud-reset">âŸ³</button>
      <button id="hud-zoom-out" title="ç¸®å°">ï¼</button>
      <button id="hud-zoom-in" title="æ”¾å¤§">ï¼‹</button>
      <button id="hud-zoom-reset" title="é‡è¨­ç‚º 1x">1x</button>
    </div>
    <div class="snap-tip hidden md:block">å¯æ‹–æ›³</div>
  </div>

  <!-- ï¼ˆå·²ç§»é™¤ï¼šç¼ºè€ƒ Base64 åŒ¯å…¥ Modalï¼‰ -->

  <!-- æ’ç¨‹ CSV åŒ¯å…¥ Modal -->
  <div id="schedule-import-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 modal">
    <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-2xl">
      <h3 class="text-xl font-bold text-cyan-300 mb-3">åŒ¯å…¥æ®µè€ƒæ’ç¨‹è³‡æ–™ï¼ˆCSVï¼‰</h3>
      <p class="text-sm text-slate-300 mb-2">è«‹å°‡ <strong>CSV æª”æ¡ˆçš„å®Œæ•´å…§å®¹</strong> è²¼å…¥ä¸‹æ–¹æ–‡å­—æ¡†ï¼ˆéœ€åŒ…å«æ¨™é¡Œåˆ—ï¼‰ã€‚</p>
      <p class="text-xs text-cyan-300 mb-3">CSV æ¨™é¡Œåˆ—ï¼šDayKey,DayName,StartTime,EndTime,SubjectName,ActivityType</p>
      <textarea id="schedule-import-data-textarea" class="w-full h-48 p-2 rounded-lg bg-slate-800/70 border border-slate-600 text-slate-100 focus:ring-focus text-sm" placeholder="è²¼ä¸Š CSV å…§å®¹..."></textarea>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btn-schedule-cancel" class="btn btn-gray">å–æ¶ˆ</button>
        <button id="btn-schedule-confirm" class="btn btn-teal">ç¢ºèªåŒ¯å…¥ä¸¦å–ä»£</button>
      </div>
    </div>
  </div>

  <!-- æ‡‰åˆ°äººæ•¸è¨­å®š Modal -->
  <div id="expected-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 modal">
    <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-sm">
      <h3 class="text-xl font-bold text-cyan-300 mb-3">è¨­å®šæ‡‰åˆ°äººæ•¸</h3>
      <label for="expected-input" class="text-sm text-slate-300">è«‹è¼¸å…¥æœ¬æ¬¡è€ƒè©¦æ‡‰åˆ°äººæ•¸ï¼š</label>
      <input id="expected-input" type="number" min="0" class="mt-2 w-full p-2 rounded-lg bg-slate-800/70 border border-slate-600 text-slate-100 focus:ring-focus" placeholder="ä¾‹å¦‚ï¼š30" />
      <div class="flex justify-end gap-2 mt-4">
        <button id="btn-expected-cancel" class="btn btn-gray">å–æ¶ˆ</button>
        <button id="btn-expected-confirm" class="btn btn-teal">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- ç¼ºè€ƒåº§è™Ÿè¨­å®š Modal -->
  <div id="absent-setup-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 modal">
    <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-lg">
      <h3 class="text-xl font-bold text-rose-300 mb-3">è¨­å®šç¼ºè€ƒåº§è™Ÿ</h3>
      <p class="text-xs text-slate-300 mb-2">å¯ç”¨é€—è™Ÿã€ç©ºæ ¼æˆ–æ›è¡Œåˆ†éš”ï¼›åƒ…æ•¸å­—æœƒè¢«ä¿ç•™ä¸¦è‡ªå‹•æ’åºã€‚</p>
      <textarea id="absent-setup-textarea" class="w-full h-36 p-2 rounded-lg bg-slate-800/70 border border-rose-400/40 text-slate-100 focus:ring-focus" placeholder="ä¾‹å¦‚ï¼š1, 5 12
25"></textarea>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btn-absent-setup-cancel" class="btn btn-gray">å–æ¶ˆ</button>
        <button id="btn-absent-setup-confirm" class="btn btn-rose">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="main-container">
    <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
    <div class="card p-4 rounded-2xl shadow-md border-b-2 border-b-sky-500 flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <h1 id="page-title" class="text-xl md:text-2xl font-extrabold text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 rounded px-1" contenteditable="true" title="é»æ“Šå³å¯ç·¨è¼¯æ¨™é¡Œ">114å¹´åº¦ç¬¬äºŒæ¬¡å®šæœŸè©•é‡</h1>
        <button id="btn-fullscreen" class="btn btn-gray" aria-pressed="false" title="åˆ‡æ›å…¨è¢å¹•">â¤¢ å…¨è¢å¹•</button>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <div id="day-buttons-container" class="flex gap-2"></div>
        <button id="btn-sample" class="btn btn-gray">ä¸‹è¼‰ CSV ç¯„ä¾‹</button>
        <button id="btn-export" class="btn btn-teal">åŒ¯å‡ºæ’ç¨‹ (CSV)</button>
        <button id="btn-import" class="btn btn-sky">åŒ¯å…¥æ’ç¨‹ (CSV)</button>
        <button id="btn-present" class="btn btn-sky">å…¨ç•«é¢å±•ç¤º</button>
        <!-- clock-hud æœƒè¢«ç¨‹å¼åµŒå…¥åˆ°é€™å€‹ç¾¤çµ„çš„æœ€å¾Œæ–¹ -->
      </div>
    </div>

    <!-- å…§å®¹å€ -->
    <div class="flex-grow flex flex-col lg:flex-row gap-4 min-h-0">
      <!-- å·¦å´ -->
      <div class="w-full lg:w-2/3 flex flex-col gap-4 min-h-0">
        <!-- ï¼ˆå·²ç§»é™¤ï¼šç•¶å‰æ—¥æœŸå¡ç‰‡ï¼‰ -->

        <!-- ç•¶å‰è€ƒç§‘é¡¯ç¤º -->
        <main id="hero" class="flex-grow flex flex-col justify-center items-center rounded-2xl shadow-xl p-8 transition-colors duration-300" style="background: linear-gradient(145deg, rgba(2,132,199,.15), rgba(67,56,202,.12));">
          <h2 class="text-2xl md:text-3xl font-bold text-slate-200 mb-4">ç›®å‰é€²è¡Œè€ƒç§‘</h2>
          <div class="rounded-2xl shadow-inner px-6 py-5 bg-slate-900/60 border border-slate-700">
            <p id="current-subject" class="text-5xl md:text-6xl font-black text-center text-sky-300">-- ç­‰å¾…æ’ç¨‹ --</p>
          </div>
          <p id="subject-time-range" class="mt-4 text-lg md:text-2xl font-medium text-slate-300">( --:-- è‡³ --:-- )</p>
          <div class="w-full max-w-xl mt-6 bg-slate-800 rounded-full h-4 shadow-inner overflow-hidden">
            <div id="subject-progress-bar" class="h-full rounded-full flex items-center justify-end pr-2 font-bold transition-all duration-700 bg-amber-400 text-slate-900" style="width:0%">
              <span id="subject-progress-text" class="text-xs">0%</span>
            </div>
          </div>
        </main>

        <!-- ç¼ºè€ƒå€å¡Š -->
        <section class="card p-5 rounded-2xl border border-rose-400/30">
          <div class="flex justify-between items-center mb-3 p-2 rounded-md">
            <h2 class="text-2xl font-semibold text-rose-300 flex items-center">ç¼ºè€ƒåº§è™Ÿè¿½è¹¤</h2>
            <div class="flex items-center gap-2">
              <button id="btn-open-expected" class="btn btn-teal" title="è¨­å®šæ‡‰åˆ°äººæ•¸">è¨­å®šæ‡‰åˆ°äººæ•¸</button>
              <button id="btn-open-absent" class="btn btn-rose" title="è¨­å®šç¼ºè€ƒåº§è™Ÿ">è¨­å®šç¼ºè€ƒåº§è™Ÿ</button>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3 mb-4 text-center">
            <div class="bg-slate-800/70 p-2 rounded-lg border border-slate-700">
              <p class="text-xs font-medium text-slate-300">æ‡‰åˆ°äººæ•¸</p>
              <p id="expected-count" class="text-5xl md:text-6xl font-bold text-slate-100">30</p>
            </div>
            <div class="bg-rose-900/30 p-2 rounded-lg border border-rose-500/30">
              <p class="text-xs font-medium text-rose-300">ç¼ºè€ƒäººæ•¸</p>
              <p id="absent-count" class="text-5xl md:text-6xl font-bold text-rose-200">0</p>
            </div>
            <div class="bg-emerald-900/30 p-2 rounded-lg border border-emerald-500/30">
              <p class="text-xs font-medium text-emerald-300">å¯¦åˆ°äººæ•¸</p>
              <p id="actual-count" class="text-5xl md:text-6xl font-bold text-emerald-200">30</p>
            </div>
          </div>

          <div class="mt-3 p-3 bg-slate-900/60 border border-rose-500/20 rounded-md">
            <p class="font-medium text-rose-300 mb-1 text-sm">ç›®å‰ç¼ºè€ƒåº§è™Ÿï¼š</p>
            <div id="absent-seat-display" class="text-lg font-extrabold text-rose-200">å°šç„¡ç¼ºè€ƒè¨˜éŒ„ã€‚</div>
          </div>

          <div id="absent-input-area" class="hidden mt-4"></div>

          <!-- ï¼ˆå·²ç§»é™¤ï¼šç¼ºè€ƒåº§è™Ÿ åŒ¯å‡º(Base64)/åŒ¯å…¥ æŒ‰éˆ•åˆ—ï¼‰ -->
        </section>
      </div>

      <!-- å³å´ï¼šæ’ç¨‹æ¦‚è¦½ -->
      <div class="w-full lg:w-1/3 card p-6 rounded-2xl shadow-xl flex flex-col min-h-0">
        <h2 id="schedule-title" class="text-2xl font-bold text-slate-100 mb-4 pb-2 border-b border-slate-700 flex-shrink-0">
          æ’ç¨‹æ¦‚è¦½
        </h2>
        <div id="schedule-timeline" class="schedule-list space-y-4">
          <h3 class="sticky top-0 z-10 text-lg font-bold text-sky-300 p-1 border-b border-slate-700 bg-slate-900/70 backdrop-blur">â˜€ï¸ ä¸Šåˆæ™‚æ®µ</h3>
          <div id="morning-schedule" class="space-y-2"></div>
          <div id="lunch-break-item" class="p-2 my-2 rounded-md text-center text-slate-200 font-semibold text-sm flex-shrink-0 bg-slate-800 border border-slate-700">
            åˆä¼‘æ™‚é–“ (11:45 - 13:05)
          </div>
          <h3 class="sticky top-[38px] z-10 text-lg font-bold text-violet-300 p-1 border-b border-slate-700 bg-slate-900/70 backdrop-blur">ğŸŒ™ ä¸‹åˆæ™‚æ®µ</h3>
          <div id="afternoon-schedule" class="space-y-2"></div>
        </div>
        <p class="text-[11px] text-slate-400 mt-3 text-center">æ™‚é–“æŒçºŒæ›´æ–°ä¸­â€¦</p>
      </div>
    </div>
  </div>

  <script>
    /* ===== æ—¢æœ‰ç‹€æ…‹/å‡½å¼ï¼ˆåŸå§‹ç¢¼ç•¥ï¼‰ ===== */
    let expectedCount = Number(localStorage.getItem('expectedCount')) || 30;
    let isAbsentInputVisible = false;

    /* === å…¨åŸŸé–å®šæ——æ¨™ï¼štrue = å›ºå®š / ä¸å¯ç¸®æ”¾ / ä¸å¯æ‹–æ›³ / ä¸å¯é¡¯ç¤ºéš±è— === */
    const CLOCK_LOCKED = true;

    let initialSchedules = {
      day1:{ name:'1/16 æ˜ŸæœŸäº”', data:[
        {start:'08:10',end:'08:50',name:'è‡ªç¿’ (40åˆ†)',type:'study'},
        {start:'08:50',end:'09:00',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'09:00',end:'10:00',name:'æ•¸å­¸ (60åˆ†)',type:'exam'},
        {start:'10:00',end:'10:10',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'10:10',end:'10:40',name:'è‡ªç¿’ (30åˆ†)',type:'study'},
        {start:'10:40',end:'10:55',name:'ä¸‹èª² (15åˆ†)',type:'break'},
        {start:'10:55',end:'11:45',name:'å¼•å°å¯«ä½œ (50åˆ†)',type:'exam'},
        {start:'11:45',end:'13:05',name:'ä¸­åˆä¼‘æ¯ (80åˆ†)',type:'break'},
        {start:'13:05',end:'13:50',name:'è‡ªç¿’ (45åˆ†)',type:'study'},
        {start:'13:50',end:'14:00',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'14:00',end:'15:00',name:'è‹±æ–‡ (60åˆ†)',type:'exam'},
        {start:'15:00',end:'15:10',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'15:10',end:'15:40',name:'è‡ªç¿’ (30åˆ†)',type:'study'},
        {start:'15:40',end:'15:50',name:'æ”¾å­¸æ™‚é–“',type:'end'},
      ]},
      day2:{ name:'1/19 æ˜ŸæœŸä¸€', data:[
        {start:'08:10',end:'08:40',name:'è‡ªç¿’ (30åˆ†)',type:'study'},
        {start:'08:40',end:'08:50',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'08:50',end:'09:50',name:'åœ‹æ–‡ (60åˆ†)',type:'exam'},
        {start:'09:50',end:'10:00',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'10:00',end:'10:30',name:'è‡ªç¿’ (30åˆ†)',type:'study'},
        {start:'10:30',end:'10:45',name:'ä¸‹èª² (15åˆ†)',type:'break'},
        {start:'10:45',end:'11:45',name:'è‡ªç„¶ (60åˆ†)',type:'exam'},
        {start:'11:45',end:'13:05',name:'ä¸­åˆä¼‘æ¯ (80åˆ†)',type:'break'},
        {start:'13:05',end:'13:50',name:'è‡ªç¿’ (45åˆ†)',type:'study'},
        {start:'13:50',end:'14:00',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'14:00',end:'14:30',name:'è‡ªç¿’ (30åˆ†)',type:'study'},
        {start:'14:30',end:'14:40',name:'ä¸‹èª² (10åˆ†)',type:'break'},
        {start:'14:40',end:'15:40',name:'ç¤¾æœƒ (60åˆ†)',type:'exam'},
        {start:'15:40',end:'15:45',name:'æ”¶å·',type:'break'},
        {start:'15:45',end:'15:55',name:'å­¸å‹™è™•å»£æ’­çµ±ä¸€æ”¾å­¸',type:'end'},
      ]},
    };

    let currentDay = 'day1';
    let currentScheduleData = initialSchedules[currentDay];

    const el = (id)=>document.getElementById(id);
    const currentSubjectEl=el('current-subject');
    const subjectTimeRangeEl=el('subject-time-range');
    const subjectProgressBarEl=el('subject-progress-bar');
    const subjectProgressTextEl=el('subject-progress-text');
    const morningScheduleEl=el('morning-schedule');
    const afternoonScheduleEl=el('afternoon-schedule');
    const lunchBreakItemEl=el('lunch-break-item');
    const absentInput=document.createElement('textarea'); // éš±è—ä¾›é‚è¼¯
    const absentDisplay=el('absent-seat-display');
    const absentCountEl=el('absent-count');
    const actualCountEl=el('actual-count');
    const expectedCountEl=el('expected-count');

    const scheduleImportModal=el('schedule-import-modal');
    const scheduleImportDataTextarea=el('schedule-import-data-textarea');
    const dayButtonsContainer=el('day-buttons-container');

    const btnSample=el('btn-sample');
    const btnExport=el('btn-export');
    const btnImport=el('btn-import');
    const btnPresent=el('btn-present');
    const btnFullscreen=el('btn-fullscreen');
    const pageTitleEl=el('page-title');

    const btnOpenExpected=el('btn-open-expected');
    const btnOpenAbsent=el('btn-open-absent');

    const expectedModal=el('expected-modal');
    const expectedInput=el('expected-input');
    const btnExpectedCancel=el('btn-expected-cancel');
    const btnExpectedConfirm=el('btn-expected-confirm');

    const absentSetupModal=el('absent-setup-modal');
    const absentSetupTextarea=el('absent-setup-textarea');
    const btnAbsentSetupCancel=el('btn-absent-setup-cancel');
    const btnAbsentSetupConfirm=el('btn-absent-setup-confirm');

    const presentationOverlay=()=>el('presentation-overlay');

    /* === v1.0.1 æ–°å¢ï¼šå±•ç¤ºå±¤æ™‚é˜ HUDï¼ˆæ”¾åœ¨ overlay è£¡ï¼‰ === */
  </script>

  <footer class="fixed bottom-2 right-4 text-[12px] text-slate-400/60 select-none">Developed by <span class="font-semibold">DennisZ</span> â€¢ v1.0.1</footer>

  <!-- å…¨ç•«é¢å±•ç¤ºè¦†è“‹å±¤ -->
  <div id="presentation-overlay" class="hidden fixed inset-0 z-[60] bg-slate-950 text-slate-100">
    <div class="absolute inset-0 flex flex-col">
      <!-- åŠ ä¸Š id ä»¥ä¾¿å°‡å±•ç¤ºæ™‚é˜åµŒå…¥ -->
      <div id="present-toolbar" class="flex items-center justify-between p-4 border-b border-slate-800 bg-slate-900/70">
        <div class="text-sm text-slate-300 space-x-3">
          <span>æŒ‰ <span class="font-bold">X</span> é–‹å•Ÿ/é—œé–‰å±•ç¤º</span>
          <span>æŒ‰ <span class="font-bold">F</span> é€²å…¥/é€€å‡ºå…¨è¢å¹•</span>
          <span>æŒ‰ <span class="font-bold">Esc</span> é—œé–‰</span>
        </div>
        <div class="hidden text-sm text-slate-300">
          ç›®å‰æ™‚é–“ï¼š<span id="pres-now" class="font-semibold text-cyan-300">--</span>
        </div>
        <button id="btn-close-present" class="btn btn-gray">é—œé–‰</button>
      </div>

      <!-- å±•ç¤ºæ¨¡å¼æ™‚é˜ï¼ˆå°‡è¢«åµŒå…¥ present-toolbarï¼‰ -->
      <div id="pres-clock" class="clock-hud hidden md:flex">
        <div class="clock-badge">ç¾åœ¨æ™‚é–“</div>
        <div class="flex flex-col leading-tight">
          <div class="clock-time">
            <span id="pres-hh">--</span><span class="clock-dot">:</span><span id="pres-mm">--</span><span class="clock-dot">:</span><span id="pres-ss">--</span>
          </div>
          <div id="pres-date" class="clock-date">--</div>
        </div>
        <div class="clock-actions flex gap-1 ml-1">
          <button id="pres-cycle" title="å¾ªç’°è§’è½">â‡²</button>
          <button id="pres-zoom-out" title="ç¸®å°">ï¼</button>
          <button id="pres-zoom-in" title="æ”¾å¤§">ï¼‹</button>
        </div>
      </div>

      <div class="flex-1 grid place-items-center p-6">
        <div class="w-full max-w-5xl text-center">
          <div class="mb-6">
            <div class="text-xl text-sky-300 tracking-widest">ç›®å‰é€²è¡Œè€ƒç§‘</div>
            <div id="pres-subject" class="mt-2 text-6xl md:text-7xl font-black text-sky-300">â€”</div>
            <div id="pres-range" class="mt-2 text-2xl text-slate-300">â€”</div>
            <div class="w-full max-w-3xl mx-auto mt-6 bg-slate-800 rounded-full h-5 shadow-inner overflow-hidden">
              <div id="pres-progress-bar" class="h-full rounded-full flex items-center justify-end pr-2 font-bold transition-all duration-700 bg-amber-400 text-slate-900" style="width:0%">
                <span id="pres-progress-text" class="text-xs">0%</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="p-4 rounded-2xl bg-slate-900/70 border border-slate-700">
              <div class="text-sm text-slate-400">æ‡‰åˆ°äººæ•¸</div>
              <div id="pres-expected" class="text-5xl font-extrabold">â€”</div>
            </div>
            <div class="p-4 rounded-2xl bg-rose-900/30 border border-rose-500/30">
              <div class="text-sm text-rose-300">ç¼ºè€ƒäººæ•¸ / åº§è™Ÿ</div>
              <div class="text-5xl font-extrabold text-rose-200"><span id="pres-absent-count">0</span></div>
              <div id="pres-absent-list" class="mt-2 text-lg font-bold text-rose-200 break-words">â€”</div>
            </div>
            <div class="p-4 rounded-2xl bg-emerald-900/30 border border-emerald-500/30">
              <div class="text-sm text-emerald-300">å¯¦åˆ°äººæ•¸</div>
              <div id="pres-actual" class="text-5xl font-extrabold text-emerald-200">â€”</div>
            </div>
          </div>

          <div class="mt-8 p-4 rounded-2xl bg-slate-900/70 border border-slate-700">
            <div class="text-sm text-slate-400">ä¸‹ä¸€å€‹ study / exam</div>
            <div id="pres-next" class="text-2xl md:text-3xl font-bold text-sky-200 mt-1">â€”</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ===== åŸåŠŸèƒ½ï¼šå·¥å…·å‡½å¼ ===== */
  const parseTime=(t)=>{const [h,m]=t.split(':').map(Number);const d=new Date();d.setHours(h,m,0,0);return d}
  const within=(now,s,e)=>now>=s&&now<e;
  function getSplitSchedules(scheduleData){
    const lunchIndex=scheduleData.findIndex(i=>i.start==='11:45'&&i.end==='13:05');
    if(lunchIndex===-1) return {morning:scheduleData,lunch:null,afternoon:[]};
    return {morning:scheduleData.slice(0,lunchIndex),lunch:scheduleData[lunchIndex],afternoon:scheduleData.slice(lunchIndex+1)};
  }
  function renderScheduleSegment(schedule,targetEl,startIndex){
    targetEl.innerHTML='';
    schedule.forEach((item,idx)=>{
      const originalIndex=startIndex+idx;
      let colorClass='text-slate-200',icon='ğŸ';
      if(item.type==='exam'){colorClass='text-sky-300 font-semibold';icon='ğŸ“'}
      else if(item.type==='study'){colorClass='text-violet-300';icon='ğŸ“š'}
      else if(item.type==='break'){colorClass='text-emerald-300';icon='â˜•'}
      const html=`
      <div id="schedule-item-${originalIndex}" class="timeline-item ${item.type} py-1 pr-2 cursor-pointer rounded-md hover:bg-slate-800/60"
           data-type="${item.type}" data-index="${originalIndex}">
        <div class="timeline-indicator"></div>
        <div class="flex items-center gap-2">
          <div class="text-xs font-bold w-12 flex-shrink-0 text-slate-400">${item.start}</div>
          <div class="flex-grow">
            <div class="text-sm ${colorClass}">${icon} ${item.name}</div>
            <div class="text-[11px] text-slate-500">çµæŸ: ${item.end}</div>
          </div>
        </div>
      </div>`;
      targetEl.insertAdjacentHTML('beforeend',html);
    });
  }
  function renderDayButtons(){
    dayButtonsContainer.innerHTML='';
    Object.keys(initialSchedules).sort().forEach(day=>{
      const schedule=initialSchedules[day];
      const isActive=day===currentDay;
      const btn=document.createElement('button');
      btn.id=`${day}-btn`; btn.textContent=schedule.name;
      btn.className=`btn ${isActive?'bg-indigo-500 text-white':'btn-gray'}`;
      btn.addEventListener('click',()=>loadSchedule(day));
      dayButtonsContainer.appendChild(btn);
    });
  }
  function loadSchedule(day){
    if(!initialSchedules[day]){
      const first=Object.keys(initialSchedules)[0];
      if(!first){ currentScheduleData=null; renderDayButtons(); renderSchedule(); updateDisplay(); return;}
      day=first;
    }
    currentDay=day;
    currentScheduleData=initialSchedules[currentDay];
    currentScheduleData.split=getSplitSchedules(currentScheduleData.data);
    renderDayButtons();
    // ï¼ˆå·²ç§»é™¤ï¼‰å·¦å´æ—¥æœŸå¡ç‰‡ï¼Œä¸å†æ›´æ–° current-schedule-date
    document.getElementById('schedule-title').textContent=`æ’ç¨‹æ¦‚è¦½ (${currentScheduleData.name})`;
    renderSchedule(); updateDisplay();
  }
  function renderSchedule(){
    if(!currentScheduleData||!currentScheduleData.data){
      morningScheduleEl.innerHTML='<p class="text-center text-slate-400">ç„¡æ’ç¨‹è³‡æ–™</p>';
      afternoonScheduleEl.innerHTML=''; lunchBreakItemEl.textContent='åˆä¼‘æ™‚é–“';
      lunchBreakItemEl.classList.remove('bg-slate-800'); return;
    }
    const {morning,lunch,afternoon}=currentScheduleData.split;
    renderScheduleSegment(morning,morningScheduleEl,0);
    const lunchIndex=currentScheduleData.data.findIndex(i=>i===lunch);
    const afternoonStartIndex=lunchIndex!==-1?lunchIndex+1:morning.length;
    renderScheduleSegment(afternoon,afternoonScheduleEl,afternoonStartIndex);
    if(lunch){
      const dur=Math.floor((parseTime(lunch.end)-parseTime(lunch.start))/60000);
      lunchBreakItemEl.innerHTML=`åˆä¼‘æ™‚é–“ ${lunch.start} - ${lunch.end} (${dur} åˆ†)`;
      lunchBreakItemEl.dataset.start=lunch.start;
      lunchBreakItemEl.dataset.end=lunch.end;
      lunchBreakItemEl.id=`schedule-item-${lunchIndex}`;
      lunchBreakItemEl.classList.add('bg-slate-800');
    }else{ lunchBreakItemEl.classList.add('hidden'); }
  }
  function computeAbsentFromRaw(raw){
    const cleaned=raw.replace(/[,ï¼Œ\s\n]+/g,' ').trim();
    const nums=cleaned.split(' ').map(s=>s.trim()).filter(s=>s&&/^\d+$/.test(s)).map(Number).sort((a,b)=>a-b);
    return [...new Set(nums)];
  }
  function updateAbsentSeats(){
    const raw=absentInput.value||'';
    const unique=computeAbsentFromRaw(raw);
    const absentCount=unique.length;
    const actual=Math.max(0, expectedCount-absentCount);
    absentDisplay.textContent=absentCount?unique.join('ã€ '):'å°šç„¡ç¼ºè€ƒè¨˜éŒ„ã€‚';
    expectedCountEl.textContent=expectedCount;
    absentCountEl.textContent=absentCount;
    actualCountEl.textContent=actual;
    localStorage.setItem('absentSeats', raw);
  }
  function showStatusMessage(message,isError=false){
    const statusMessageEl=document.getElementById('status-message');
    statusMessageEl.textContent=message;
    statusMessageEl.classList.remove('opacity-0');
    statusMessageEl.style.background=isError?'rgba(244,63,94,.9)':'rgba(16,185,129,.9)';
    statusMessageEl.style.pointerEvents='auto';
    clearTimeout(window.__statusTimer);
    window.__statusTimer=setTimeout(()=>{
      statusMessageEl.classList.add('opacity-0');
      statusMessageEl.style.pointerEvents='none';
    },2200);
  }

  /* ===== CSV/ä¸‹è¼‰ï¼ˆåŸå‡½å¼ä¿ç•™ï¼‰ ===== */
  function convertToCsv(schedules){
    const header='DayKey,DayName,StartTime,EndTime,SubjectName,ActivityType\n';
    let csv=header;
    Object.keys(schedules).sort().forEach(key=>{
      const sc=schedules[key];
      sc.data.forEach(item=>{
        const row=[ key, `"${sc.name.replace(/"/g,'""')}"`, item.start, item.end, `"${item.name.replace(/"/g,'""')}"`, item.type ].join(',');
        csv+=row+'\n';
      });
    });
    return '\ufeff'+csv;
  }
  function parseCsv(csvString){
    const schedules={};
    csvString=csvString.replace(/^\ufeff/,'');
    const lines=csvString.split('\n').filter(l=>l.trim()!=='');
    if(lines.length<2) throw new Error('CSV å…§å®¹ä¸è¶³ï¼Œè«‹ç¢ºèªæ¨™é¡Œåˆ—èˆ‡è³‡æ–™åˆ—ã€‚');
    const dataLines=lines.slice(1);
    dataLines.forEach((line,i)=>{
      const values=line.match(/(?:[^,"]+|"[^"]*")+/g)?.map(v=>v.trim().replace(/^"|"$/g,'').replace(/""/g,'"'))||[];
      if(values.length!==6){ console.warn(`Line ${i+2} æ¬„ä½æ•¸ä¸ç¬¦ï¼Œå·²ç•¥éï¼š`,line); return;}
      const [DayKey,DayName,StartTime,EndTime,SubjectName,ActivityType]=values;
      if(!/^\d{2}:\d{2}$/.test(StartTime)||!/^\d{2}:\d{2}$/.test(EndTime)) throw new Error(`ç¬¬ ${i+2} è¡Œæ™‚é–“æ ¼å¼éŒ¯èª¤ï¼š${StartTime}-${EndTime}`);
      if(!['exam','break','study','end'].includes(ActivityType)) throw new Error(`ç¬¬ ${i+2} è¡Œæ´»å‹•é¡å‹éŒ¯èª¤ï¼š${ActivityType}`);
      if(!schedules[DayKey]) schedules[DayKey]={name:DayName,data:[]};
      schedules[DayKey].data.push({start:StartTime,end:EndTime,name:SubjectName,type:ActivityType});
    });
    return schedules;
  }
  function downloadFile(content,fileName,mimeType){
    const blob=new Blob([content],{type:mimeType});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=fileName; document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  function exportScheduleData(){
    if(!Object.keys(initialSchedules).length) return showStatusMessage('æ’ç¨‹è³‡æ–™ç‚ºç©ºï¼Œè«‹å…ˆåŒ¯å…¥æˆ–å»ºç«‹æ’ç¨‹ã€‚',true);
    const csv=convertToCsv(initialSchedules);
    downloadFile(csv,'exam_schedule.csv','text/csv;charset=utf-8;');
    showStatusMessage('æ’ç¨‹è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºç‚º exam_schedule.csvï¼');
  }
  function downloadSampleCsv(){
    const csv=convertToCsv(initialSchedules);
    downloadFile(csv,'exam_schedule_sample.csv','text/csv;charset=utf-8;');
    showStatusMessage('CSV ç¯„ä¾‹æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
  }

  /* ===== v1.0.1ï¼šå±•ç¤ºå±¤åŒæ­¥ ===== */
  function updatePresentationView(){
    const subject=document.getElementById('current-subject')?.textContent||'â€”';
    const range=document.getElementById('subject-time-range')?.textContent||'';
    const raw=absentInput?.value||'';
    const list=computeAbsentFromRaw(raw);
    const absentCount=list.length;
    const actual=Math.max(0, expectedCount-absentCount);
    el('pres-subject').textContent=subject;
    el('pres-range').textContent=range;
    el('pres-expected').textContent=String(expectedCount);
    el('pres-absent-count').textContent=String(absentCount);
    el('pres-absent-list').textContent=list.length?list.join('ã€ '):'â€”';
    el('pres-actual').textContent=String(actual);

    const now=new Date();
    const fmt={year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false};
    el('pres-now').textContent=now.toLocaleString('zh-TW',fmt);

    let pct=0,currentIndex=-1,currentItem=null,nextInfo='â€”';
    if(currentScheduleData && currentScheduleData.data){
      const schedule=currentScheduleData.data;
      for(let i=0;i<schedule.length;i++){
        const s=parseTime(schedule[i].start), e=parseTime(schedule[i].end);
        if(within(now,s,e)){ currentItem=schedule[i]; currentIndex=i; pct=Math.min(100,Math.round(((now-s)/(e-s))*100)); break;}
      }
      for(let j=currentIndex+1;j<schedule.length;j++){
        if(['study','exam'].includes(schedule[j].type)){ nextInfo=`${schedule[j].start}ã€€${schedule[j].name}`; break;}
      }
    }
    const bar=el('pres-progress-bar'); const txt=el('pres-progress-text');
    bar.style.width=pct+'%'; txt.textContent=pct+'%';
    el('pres-next').textContent=nextInfo;
  }
  function openPresentation(){
    updatePresentationView();
    presentationOverlay().classList.remove('hidden');
    const presClock = el('pres-clock');
    presClock.classList.remove('hidden');
    if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.().catch(()=>{}); }
  }
  function closePresentation(){
    presentationOverlay().classList.add('hidden');
    if(document.fullscreenElement){ document.exitFullscreen?.().catch(()=>{}); }
  }

  /* ===== å¤§æ™‚é˜ï¼ˆä¸€èˆ¬/å±•ç¤ºï¼‰ æ›´æ–° ===== */
  function fmtWeekday(d){ return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()] }
  function pad(n){ return String(n).padStart(2,'0') }
  function tickClocks(){
    const now=new Date();
    const hh=pad(now.getHours()), mm=pad(now.getMinutes()), ss=pad(now.getSeconds());
    const dateStr=`${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())}ï¼ˆ${fmtWeekday(now)}ï¼‰`;
    const hudHH=el('hud-hh'); if(hudHH){ hudHH.textContent=hh; el('hud-mm').textContent=mm; el('hud-ss').textContent=ss; el('hud-date').textContent=dateStr; }
    const presHH=el('pres-hh'); if(presHH){ presHH.textContent=hh; el('pres-mm').textContent=mm; el('pres-ss').textContent=ss; el('pres-date').textContent=dateStr; }
  }

  /* ===== ä»ä¿ç•™ï¼šæ‹–æ›³/ç¸®æ”¾å·¥å…·ï¼ˆé–å®šæ™‚ä¸æœƒè¢«å•Ÿç”¨ï¼‰ ===== */
  function makeDraggable(box, storageKey){
    let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
    const setPos=(l,t)=>{ box.style.left=l+'px'; box.style.top=t+'px'; box.style.right='auto'; box.style.bottom='auto'; }
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    function cycleCorner(){
      const rect=box.getBoundingClientRect();
      const vw=window.innerWidth, vh=window.innerHeight;
      const current=localStorage.getItem(storageKey+'-corner')||'tr';
      const order=['tr','br','bl','tl'];
      const next=order[(order.indexOf(current)+1)%order.length];
      localStorage.setItem(storageKey+'-corner', next);
      const margin=16;
      const map={
        tl:[margin,margin],
        tr:[vw-rect.width-margin, margin],
        br:[vw-rect.width-margin, vh-rect.height-margin],
        bl:[margin, vh-rect.height-margin],
      };
      setPos(...map[next]);
      localStorage.setItem(storageKey, JSON.stringify({left:map[next][0], top:map[next][1]}));
    }
    function onDown(e){
      dragging=true; box.classList.add('dragging');
      const rect=box.getBoundingClientRect();
      startLeft=rect.left; startTop=rect.top;
      startX = (e.touches? e.touches[0].clientX : e.clientX);
      startY = (e.touches? e.touches[0].clientY : e.clientY);
      e.preventDefault();
    }
    function onMove(e){
      if(!dragging) return;
      const x=(e.touches? e.touches[0].clientX : e.clientX);
      const y=(e.touches? e.touches[0].clientY : e.clientY);
      const dx=x-startX, dy=y-startY;
      const vw=window.innerWidth, vh=window.innerHeight;
      const rect=box.getBoundingClientRect();
      const left=clamp(startLeft+dx, 8, vw-rect.width-8);
      const top =clamp(startTop +dy, 8, vh-rect.height-8);
      setPos(left,top);
    }
    function onUp(){
      if(!dragging) return;
      dragging=false; box.classList.remove('dragging');
      const rect=box.getBoundingClientRect();
      localStorage.setItem(storageKey, JSON.stringify({left:rect.left, top:rect.top}));
    }
    box.addEventListener('mousedown', onDown);
    box.addEventListener('touchstart', onDown, {passive:false});
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('mouseup', onUp);
    window.addEventListener('touchend', onUp);
    return { cycleCorner };
  }
  function restorePosition(box, storageKey, defaultCorner='tr'){
    const vw=window.innerWidth, vh=window.innerHeight;
    const saved=localStorage.getItem(storageKey);
    const margin=16;
    if(saved){
      try{
        const {left, top}=JSON.parse(saved);
        box.style.left=left+'px'; box.style.top=top+'px';
        box.style.right='auto'; box.style.bottom='auto';
        return;
      }catch{}
    }
    const rect=box.getBoundingClientRect();
    const map={
      tl:[margin,margin],
      tr:[vw-rect.width-margin, margin],
      br:[vw-rect.width-margin, vh-rect.height-margin],
      bl:[margin, vh-rect.height-margin],
    };
    const pos=map[defaultCorner]||map.tr;
    box.style.left=pos[0]+'px'; box.style.top=pos[1]+'px';
    box.style.right='auto'; box.style.bottom='auto';
    localStorage.setItem(storageKey, JSON.stringify({left:pos[0], top:pos[1]}));
    localStorage.setItem(storageKey+'-corner', defaultCorner);
  }
  function applyScale(elm, storageKey, defaultScale = 2){
    const raw = localStorage.getItem(storageKey);
    const s = raw ? Number(raw) : defaultScale;
    elm?.style?.setProperty('--clock-scale', s);
  }
  function changeScale(elm, storageKey, delta){
    const cur = Number(localStorage.getItem(storageKey)) || 2;
    let next = Math.round((cur + delta) * 10) / 10;
    next = Math.max(0.5, Math.min(4, next));
    localStorage.setItem(storageKey, String(next));
    elm?.style?.setProperty('--clock-scale', next);
    try{ showStatusMessage?.(`æ™‚é˜ç¸®æ”¾ï¼š${next}x`); }catch{}
  }
  function resetScale(elm, storageKey, to = 1){
    localStorage.setItem(storageKey, String(to));
    elm?.style?.setProperty('--clock-scale', to);
    try{ showStatusMessage?.(`æ™‚é˜ç¸®æ”¾ï¼š${to}x`); }catch{}
  }

  /* ===== ä¸»æ›´æ–° ===== */
  function updateDisplay(){
    if(!currentScheduleData||!currentScheduleData.data){
      currentSubjectEl.textContent='ç„¡æ’ç¨‹è³‡æ–™';
      subjectTimeRangeEl.textContent='---';
      subjectProgressBarEl.style.width='0%';
      subjectProgressTextEl.textContent='0%';
      return;
    }
    const schedule=currentScheduleData.data;
    const now=new Date();

    let currentItem=null,currentIndex=-1,pct=0;
    document.querySelectorAll('.timeline-item').forEach(el=>el.classList.remove('active'));
    for(let i=0;i<schedule.length;i++){
      const item=schedule[i];
      const s=parseTime(item.start), e=parseTime(item.end);
      if(within(now,s,e)){ currentItem=item; currentIndex=i; pct=Math.min(100, Math.round(((now-s)/(e-s))*100)); break; }
    }

    const hero=document.getElementById('hero');
    if(currentItem){
      currentSubjectEl.textContent=currentItem.name;
      subjectTimeRangeEl.textContent=`(${currentItem.start} è‡³ ${currentItem.end})`;
      subjectProgressBarEl.style.width=pct+'%';
      subjectProgressTextEl.textContent=pct+'%';

      if(currentItem.type==='exam') hero.style.background='linear-gradient(145deg, rgba(14,165,233,.20), rgba(99,102,241,.18))';
      else if(currentItem.type==='break') hero.style.background='linear-gradient(145deg, rgba(251,191,36,.20), rgba(34,197,94,.18))';
      else if(currentItem.type==='study') hero.style.background='linear-gradient(145deg, rgba(167,139,250,.22), rgba(56,189,248,.18))';
      else hero.style.background='linear-gradient(145deg, rgba(148,163,184,.15), rgba(100,116,139,.15))';

      const itemEl=document.getElementById(`schedule-item-${currentIndex}`); if(itemEl) itemEl.classList.add('active');
    }else{
      currentSubjectEl.textContent='ä»Šæ—¥æ’ç¨‹å·²çµæŸ / å°šæœªé–‹å§‹';
      subjectTimeRangeEl.textContent='---';
      subjectProgressBarEl.style.width='0%';
      subjectProgressTextEl.textContent='0%';
      hero.style.background='linear-gradient(145deg, rgba(148,163,184,.12), rgba(100,116,139,.12))';
    }

    if(!presentationOverlay().classList.contains('hidden')) updatePresentationView();
  }

  /* ===== åˆå§‹åŒ– ===== */
  function init(){
    const savedSeats=localStorage.getItem('absentSeats'); if(savedSeats){ absentInput.value=savedSeats; }
    expectedCount=Number(localStorage.getItem('expectedCount'))||expectedCount;
    updateAbsentSeats();

    const savedCSV=localStorage.getItem('schedulesCSV');
    if(savedCSV){ try{ initialSchedules=parseCsv(savedCSV);}catch{} }
    const firstDayKey=Object.keys(initialSchedules).sort()[0];
    if(firstDayKey) loadSchedule(firstDayKey); else { renderDayButtons(); renderSchedule(); updateDisplay(); }

    setInterval(()=>{ updateDisplay(); tickClocks(); }, 1000);
    tickClocks();

    // äº‹ä»¶ç¶å®šï¼ˆåŸï¼‰
    document.getElementById('btn-close-present').addEventListener('click', closePresentation);
    btnSample.addEventListener('click', downloadSampleCsv);
    btnExport.addEventListener('click', exportScheduleData);
    btnImport.addEventListener('click', ()=>scheduleImportModal.classList.remove('hidden'));

	btnPresent.addEventListener('click', () => {
	  const hidden = presentationOverlay().classList.contains('hidden');

	  if (hidden) {
		openPresentation();
		btnPresent.textContent = 'å…¨ç•«é¢å±•ç¤º';
		btnPresent.setAttribute('aria-pressed', 'true');
	  } else {
		closePresentation();
		btnPresent.textContent = 'å…¨ç•«é¢å±•ç¤º';
		btnPresent.setAttribute('aria-pressed', 'false');
	  }
	});


    document.getElementById('btn-schedule-cancel').addEventListener('click', ()=>scheduleImportModal.classList.add('hidden'));
    document.getElementById('btn-schedule-confirm').addEventListener('click', ()=>{
      const csv=scheduleImportDataTextarea.value.trim();
      scheduleImportModal.classList.add('hidden');
      if(!csv) return showStatusMessage('æ’ç¨‹åŒ¯å…¥å–æ¶ˆæˆ–ç„¡è³‡æ–™ã€‚',true);
      try{
        const newSchedules=parseCsv(csv);
        if(!Object.keys(newSchedules).length) throw new Error('è§£æå¾Œæœªå¾—åˆ°ä»»ä½•æœ‰æ•ˆçš„æ’ç¨‹è³‡æ–™ã€‚');
        initialSchedules=newSchedules;
        const first=Object.keys(initialSchedules).sort()[0];
        loadSchedule(first);
        showStatusMessage(`æ’ç¨‹åŒ¯å…¥æˆåŠŸï¼å·²è¼‰å…¥ ${Object.keys(initialSchedules).length} å¤©æ’ç¨‹ã€‚`);
        localStorage.setItem('schedulesCSV', csv);
      }catch(e){ console.error(e); showStatusMessage(`æ’ç¨‹åŒ¯å…¥å¤±æ•—ï¼š${e.message}`,true); }
    });

    btnOpenExpected.addEventListener('click', ()=>{ el('expected-modal').classList.remove('hidden'); expectedInput.value=String(expectedCount); setTimeout(()=>expectedInput.select(),0); });
    btnExpectedCancel.addEventListener('click', ()=>el('expected-modal').classList.add('hidden'));
    btnExpectedConfirm.addEventListener('click', ()=>{
      const val=Number(expectedInput.value);
      if(!Number.isFinite(val)||val<0){ showStatusMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„äººæ•¸ï¼ˆ>= 0ï¼‰ã€‚',true); return; }
      expectedCount=Math.floor(val); localStorage.setItem('expectedCount', String(expectedCount));
      updateAbsentSeats(); el('expected-modal').classList.add('hidden'); showStatusMessage('å·²æ›´æ–°æ‡‰åˆ°äººæ•¸ã€‚');
    });
    expectedInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnExpectedConfirm.click(); } });

    btnOpenAbsent.addEventListener('click', ()=>{
      el('absent-setup-modal').classList.remove('hidden');
      const raw=localStorage.getItem('absentSeats')||(absentInput?.value||'');
      absentSetupTextarea.value=raw; setTimeout(()=>absentSetupTextarea.focus(),0);
    });
    btnAbsentSetupCancel.addEventListener('click', ()=>el('absent-setup-modal').classList.add('hidden'));
    btnAbsentSetupConfirm.addEventListener('click', ()=>{
      const raw=absentSetupTextarea.value||''; absentInput.value=raw; updateAbsentSeats();
      el('absent-setup-modal').classList.add('hidden'); showStatusMessage('å·²æ›´æ–°ç¼ºè€ƒåº§è™Ÿã€‚');
    });

    function syncFsBtn(){
      const isFs=!!document.fullscreenElement; btnFullscreen.setAttribute('aria-pressed', isFs?'true':'false');
      btnFullscreen.textContent=isFs?'â¤¢ é€€å‡ºå…¨è¢å¹•':'â¤¢ å…¨è¢å¹•';
    }
    btnFullscreen.addEventListener('click', async ()=>{
      try{ if(!document.fullscreenElement){ await document.documentElement.requestFullscreen(); } else { await document.exitFullscreen(); } }
      catch(e){ showStatusMessage('å…¨è¢å¹•åˆ‡æ›å¤±æ•—', true); }
    });
    document.addEventListener('fullscreenchange', syncFsBtn); syncFsBtn();

    /* === éµç›¤å¿«æ·éµï¼šä¿ç•™ F / Xï¼›C åœ¨é–å®šæ™‚ç„¡æ•ˆ === */
    document.addEventListener('keydown', (e)=>{
      const tag=(e.target&&e.target.tagName)||''; const typing=['INPUT','TEXTAREA'].includes(tag)||(e.target&&e.target.isContentEditable);

      // Fï¼šå…¨è¢å¹•
      if(!typing && (e.key==='f'||e.key==='F')){
        e.preventDefault();
        try{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.().catch(()=>{});} else { document.exitFullscreen?.().catch(()=>{});} }
        catch{ showStatusMessage('å…¨è¢å¹•åˆ‡æ›å¤±æ•—', true); }
      }

      // Xï¼šå±•ç¤ºå±¤é–‹é—œ
      if(!typing && (e.key==='x'||e.key==='X')){
        e.preventDefault();
        const hidden=presentationOverlay().classList.contains('hidden');
        hidden?openPresentation():closePresentation();
      }

      // Cï¼šæ™‚é˜é¡¯ç¤º/éš±è—ï¼ˆé–å®šæ™‚é˜»æ“‹ï¼‰
      if(!typing && (e.key==='c'||e.key==='C')){
        e.preventDefault();
        if(CLOCK_LOCKED){
          showStatusMessage('æ™‚é˜å·²é–å®š / ç„¡æ³•é¡¯ç¤ºæˆ–éš±è—');
          return;
        }
        const hud = document.getElementById('clock-hud');
        const pres = document.getElementById('pres-clock');
        hud?.classList.toggle('hidden');
        const overlayVisible = !presentationOverlay().classList.contains('hidden');
        if(overlayVisible){ pres?.classList.toggle('hidden'); }
        const isVisible = !(hud?.classList.contains('hidden'));
        try{ showStatusMessage?.(isVisible ? 'æ™‚é˜é¡¯ç¤º' : 'æ™‚é˜éš±è—'); }catch{}
      }
    });

    /* === ä¸€èˆ¬æ¨¡å¼ï¼šé–å®šæ™‚åµŒå…¥é ‚éƒ¨æ§åˆ¶åˆ—ã€ç§»é™¤æ‹–æ›³ç¸®æ”¾ === */
    {
      const hud=el('clock-hud');
      const rightGroup = btnPresent.parentElement; // é ‚éƒ¨æ§åˆ¶åˆ—å³å´ç¾¤çµ„
      if(CLOCK_LOCKED){
        rightGroup.appendChild(hud);
        hud.classList.add('docked');
        hud.style.setProperty('--clock-scale', 1);
      }else{
        const hudCtl=makeDraggable(hud, 'hud-pos');
        restorePosition(hud, 'hud-pos', localStorage.getItem('hud-pos-corner')||'tr');
        el('hud-cycle')?.addEventListener('click', (e)=>{ e.stopPropagation(); hudCtl.cycleCorner(); });
        el('hud-reset')?.addEventListener('click', (e)=>{
          e.stopPropagation();
          localStorage.removeItem('hud-pos');
          localStorage.setItem('hud-pos-corner','tr');
          restorePosition(hud, 'hud-pos', 'tr');
        });
        applyScale(hud, 'hud-scale', 2);
        document.getElementById('hud-zoom-in')?.addEventListener('click',  (e)=>{ e.stopPropagation(); changeScale(hud, 'hud-scale',  +0.1); });
        document.getElementById('hud-zoom-out')?.addEventListener('click', (e)=>{ e.stopPropagation(); changeScale(hud, 'hud-scale',  -0.1); });
        document.getElementById('hud-zoom-reset')?.addEventListener('click',(e)=>{ e.stopPropagation(); resetScale(hud, 'hud-scale', 1); });
      }
    }

    /* === å±•ç¤ºæ¨¡å¼ï¼šé–å®šæ™‚åµŒå…¥å·¥å…·åˆ—ã€ç§»é™¤æ‹–æ›³ç¸®æ”¾ === */
    {
      const presHud=el('pres-clock');
      const toolbar=el('present-toolbar');
      if(CLOCK_LOCKED){
        toolbar.insertBefore(presHud, toolbar.lastElementChild);
        presHud.classList.add('docked');
        presHud.style.setProperty('--clock-scale', 1);
      }else{
        const presCtl=makeDraggable(presHud, 'pres-hud-pos');
        restorePosition(presHud, 'pres-hud-pos', localStorage.getItem('pres-hud-pos-corner')||'tr');
        el('pres-cycle')?.addEventListener('click', (e)=>{ e.stopPropagation(); presCtl.cycleCorner(); });
        applyScale(presHud, 'pres-scale', 2);
        document.getElementById('pres-zoom-in')?.addEventListener('click',   (e)=>{ e.stopPropagation(); changeScale(presHud, 'pres-scale',  +0.1); });
        document.getElementById('pres-zoom-out')?.addEventListener('click',  (e)=>{ e.stopPropagation(); changeScale(presHud, 'pres-scale',  -0.1); });
      }
    }
  }
</script>
</body>
</html>



